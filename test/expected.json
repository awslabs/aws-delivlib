Resources:
  CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildPipeline/ArtifactsBucket/Resource
  CodeCommitPipelineBuildPipelineRole1843599A:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildPipeline/Role/Resource
  CodeCommitPipelineBuildPipelineRoleDefaultPolicy94C30F44:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineBuildProject9F59E8AA
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineHelloLinux82ECC4D2
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineHelloWindows397414E5
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineNpm0D31AEFC
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineNuGet67CE1BA7
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineMavenB7154296
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineGitHub0797840C
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineGitHubPages53B77CF6
                - Arn
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineBuildPipelineRoleDefaultPolicy94C30F44
      Roles:
        - Ref: CodeCommitPipelineBuildPipelineRole1843599A
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildPipeline/Role/DefaultPolicy/Resource
  CodeCommitPipelineBuildPipeline656B8CCB:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn:
        Fn::GetAtt:
          - CodeCommitPipelineBuildPipelineRole1843599A
          - Arn
      Stages:
        - Actions:
            - ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: "1"
              Configuration:
                Owner: awslabs
                Repo: aws-delivlib-sample
                Branch: master
                OAuthToken:
                  Ref: CodeCommitPipelineBuildPipelineGitHubTokenParameter9FBEDC6B
                PollForSourceChanges: false
              InputArtifacts:
                []
              Name: Pull
              OutputArtifacts:
                - Name: Source
              RunOrder: 1
          Name: Source
        - Actions:
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineBuildProject9F59E8AA
              InputArtifacts:
                - Name: Source
              Name: Build
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              RunOrder: 1
          Name: Build
        - Actions:
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineHelloLinux82ECC4D2
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: TestHelloLinux
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineHelloLinuxTestHelloLinux1EC7E001
              RunOrder: 1
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineHelloWindows397414E5
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: TestHelloWindows
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineHelloWindowsTestHelloWindowsA5D9F16F
              RunOrder: 2
          Name: Test
        - Actions:
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineNpm0D31AEFC
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: NpmPublish
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineNpmNpmPublishF3497B8A
              RunOrder: 1
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineNuGet67CE1BA7
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: NuGetPublish
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineNuGetNuGetPublishD08C1873
              RunOrder: 2
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineMavenB7154296
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: MavenPublish
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineMavenMavenPublish23517E96
              RunOrder: 3
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineGitHub0797840C
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: GitHubPublish
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineGitHubGitHubPublish9C2DACED
              RunOrder: 4
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineGitHubPages53B77CF6
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: GitHubPagesPublish
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineGitHubPagesGitHubPagesPublishCDA7CDC1
              RunOrder: 5
          Name: Publish
      ArtifactStore:
        Location:
          Ref: CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
        Type: S3
      RestartExecutionOnUpdate: true
    DependsOn:
      - CodeCommitPipelineBuildPipelineRole1843599A
      - CodeCommitPipelineBuildPipelineRoleDefaultPolicy94C30F44
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildPipeline/Resource
  CodeCommitPipelineBuildPipelineSourcePullWebhookResource0898F523:
    Type: AWS::CodePipeline::Webhook
    Properties:
      Authentication: GITHUB_HMAC
      AuthenticationConfiguration:
        SecretToken:
          Ref: CodeCommitPipelineBuildPipelineGitHubTokenParameter9FBEDC6B
      Filters:
        - JsonPath: $.ref
          MatchEquals: refs/heads/{Branch}
      TargetAction: Pull
      TargetPipeline:
        Ref: CodeCommitPipelineBuildPipeline656B8CCB
      TargetPipelineVersion: 1
      RegisterWithThirdParty: true
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildPipeline/Source/Pull/WebhookResource
  CodeCommitPipelinesuperchainAdoptRepository67DBB814:
    Type: Custom::ECRAdoptedRepository
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62c52BE89E9
          - Arn
      RepositoryName:
        Fn::Select:
          - 0
          - Fn::Split:
              - ":"
              - Ref: CodeCommitPipelinesuperchainImageNameF1669FD4
      PolicyDocument:
        Statement:
          - Action:
              - ecr:GetDownloadUrlForLayer
              - ecr:BatchGetImage
              - ecr:BatchCheckLayerAvailability
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Sid: CodeBuild
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/superchain/AdoptRepository/Resource
  CodeCommitPipelineBuildProjectRoleC6347B6E:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildProject/Role/Resource
  CodeCommitPipelineBuildProjectRoleDefaultPolicy1184486E:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineBuildProject9F59E8AA
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineBuildProject9F59E8AA
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineBuildProjectRoleDefaultPolicy1184486E
      Roles:
        - Ref: CodeCommitPipelineBuildProjectRoleC6347B6E
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildProject/Role/DefaultPolicy/Resource
  CodeCommitPipelineBuildProject9F59E8AA:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        EnvironmentVariables:
          - Name: DELIVLIB_ENV_TEST
            Type: PLAINTEXT
            Value: MAGIC_1924
        Image:
          Fn::Join:
            - ""
            - - Fn::Select:
                  - 4
                  - Fn::Split:
                      - ":"
                      - Fn::Join:
                          - ""
                          - - "arn:"
                            - Ref: AWS::Partition
                            - ":ecr:"
                            - Ref: AWS::Region
                            - ":"
                            - Ref: AWS::AccountId
                            - :repository/
                            - Fn::GetAtt:
                                - CodeCommitPipelinesuperchainAdoptRepository67DBB814
                                - RepositoryName
              - .dkr.ecr.
              - Fn::Select:
                  - 3
                  - Fn::Split:
                      - ":"
                      - Fn::Join:
                          - ""
                          - - "arn:"
                            - Ref: AWS::Partition
                            - ":ecr:"
                            - Ref: AWS::Region
                            - ":"
                            - Ref: AWS::AccountId
                            - :repository/
                            - Fn::GetAtt:
                                - CodeCommitPipelinesuperchainAdoptRepository67DBB814
                                - RepositoryName
              - .amazonaws.com/
              - Fn::GetAtt:
                  - CodeCommitPipelinesuperchainAdoptRepository67DBB814
                  - RepositoryName
              - ":"
              - Fn::Select:
                  - 1
                  - Fn::Split:
                      - ":"
                      - Ref: CodeCommitPipelinesuperchainImageNameF1669FD4
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineBuildProjectRoleC6347B6E
          - Arn
      Source:
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildProject/Resource
  CodeCommitPipelineBuildProjectOnBuildFailed2A08058D:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.codebuild
        detail-type:
          - CodeBuild Build State Change
        detail:
          project-name:
            - Ref: CodeCommitPipelineBuildProject9F59E8AA
          build-status:
            - FAILED
      State: ENABLED
      Targets:
        - Arn:
            Ref: CodeCommitPipelineNotificationsTopic36C2D667
          Id: NotificationsTopic
          InputTransformer:
            InputTemplate: '"aws-delivlib test pipeline build failed"'
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildProject/OnBuildFailed/Resource
  CodeCommitPipelineNotificationsTopic36C2D667:
    Type: AWS::SNS::Topic
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/NotificationsTopic/Resource
  CodeCommitPipelineNotificationsTopicNotifyEmail146B339F:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: aws-cdk-dev+delivlib-test@amazon.com
      Protocol: email
      TopicArn:
        Ref: CodeCommitPipelineNotificationsTopic36C2D667
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/NotificationsTopic/NotifyEmail/Resource
  CodeCommitPipelineNotificationsTopicPolicyBBE90C33:
    Type: AWS::SNS::TopicPolicy
    Properties:
      PolicyDocument:
        Statement:
          - Action: sns:Publish
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              Ref: CodeCommitPipelineNotificationsTopic36C2D667
            Sid: "0"
        Version: "2012-10-17"
      Topics:
        - Ref: CodeCommitPipelineNotificationsTopic36C2D667
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/NotificationsTopic/Policy/Resource
  CodeCommitPipelinePipelineWatcherPollerServiceRole0A1D8005:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/Poller/ServiceRole/Resource
  CodeCommitPipelinePipelineWatcherPollerServiceRoleDefaultPolicyE2104AD1:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: codepipeline:GetPipelineState
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":codepipeline:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - ":"
                  - Ref: CodeCommitPipelineBuildPipeline656B8CCB
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelinePipelineWatcherPollerServiceRoleDefaultPolicyE2104AD1
      Roles:
        - Ref: CodeCommitPipelinePipelineWatcherPollerServiceRole0A1D8005
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/Poller/ServiceRole/DefaultPolicy/Resource
  CodeCommitPipelinePipelineWatcherPoller5C65ACDE:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        ZipFile: >-
          "use strict";

          Object.defineProperty(exports, "__esModule", { value: true });

          const AWS = require("aws-sdk");

          // export for tests

          exports.codePipeline = new AWS.CodePipeline();

          exports.logger = {
              log: (line) => process.stdout.write(line)
          };

          /**
           * Lambda function for checking the stages of a CodePipeline and emitting log
           * entries with { failedCount = <no. of failed stages> } for async metric
           * aggregation via metric filters.
           *
           * It requires the pipeline's name be set as the 'PIPELINE_NAME' environment variable.
           */
          async function handler() {
              const pipelineName = process.env.PIPELINE_NAME;
              if (!pipelineName) {
                  throw new Error("Pipeline name expects environment variable: 'PIPELINE_NAME'");
              }
              const state = await exports.codePipeline.getPipelineState({
                  name: pipelineName
              }).promise();
              let failedCount = 0;
              if (state.stageStates) {
                  failedCount = state.stageStates
                      .filter(stage => stage.latestExecution !== undefined && stage.latestExecution.status === 'Failed')
                      .length;
              }
              exports.logger.log(JSON.stringify({
                  failedCount
              }));
          }

          exports.handler = handler;

          //# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2F0Y2hlci1oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsid2F0Y2hlci1oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQWdDO0FBRWhDLG1CQUFtQjtBQUNOLFFBQUEsWUFBWSxHQUFHLElBQUksR0FBRyxDQUFDLFlBQVksRUFBRSxDQUFDO0FBQ3RDLFFBQUEsTUFBTSxHQUFHO0lBQ3BCLEdBQUcsRUFBRSxDQUFDLElBQVksRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO0NBQ2xELENBQUM7QUFFRjs7Ozs7O0dBTUc7QUFDSSxLQUFLLFVBQVUsT0FBTztJQUMzQixNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQztJQUMvQyxJQUFJLENBQUMsWUFBWSxFQUFFO1FBQ2pCLE1BQU0sSUFBSSxLQUFLLENBQUMsNkRBQTZELENBQUMsQ0FBQztLQUNoRjtJQUNELE1BQU0sS0FBSyxHQUFHLE1BQU0sb0JBQVksQ0FBQyxnQkFBZ0IsQ0FBQztRQUNoRCxJQUFJLEVBQUUsWUFBWTtLQUNuQixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7SUFFYixJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUM7SUFDcEIsSUFBSSxLQUFLLENBQUMsV0FBVyxFQUFFO1FBQ3JCLFdBQVcsR0FBRyxLQUFLLENBQUMsV0FBVzthQUM1QixNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsZUFBZSxLQUFLLFNBQVMsSUFBSSxLQUFLLENBQUMsZUFBZSxDQUFDLE1BQU0sS0FBSyxRQUFRLENBQUM7YUFDakcsTUFBTSxDQUFDO0tBQ1g7SUFDRCxjQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7UUFDeEIsV0FBVztLQUNaLENBQUMsQ0FBQyxDQUFDO0FBQ04sQ0FBQztBQWxCRCwwQkFrQkMifQ==
      Handler: index.handler
      Role:
        Fn::GetAtt:
          - CodeCommitPipelinePipelineWatcherPollerServiceRole0A1D8005
          - Arn
      Runtime: nodejs8.10
      Environment:
        Variables:
          PIPELINE_NAME:
            Ref: CodeCommitPipelineBuildPipeline656B8CCB
    DependsOn:
      - CodeCommitPipelinePipelineWatcherPollerServiceRole0A1D8005
      - CodeCommitPipelinePipelineWatcherPollerServiceRoleDefaultPolicyE2104AD1
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/Poller/Resource
  CodeCommitPipelinePipelineWatcherPollerAllowEventRuledelivlibtestCodeCommitPipelinePipelineWatcherTrigger0F55C26402F871FD:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: CodeCommitPipelinePipelineWatcherPoller5C65ACDE
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
          - CodeCommitPipelinePipelineWatcherTriggerA38A4AD0
          - Arn
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/Poller/AllowEventRuledelivlibtestCodeCommitPipelinePipelineWatcherTrigger0F55C264
  CodeCommitPipelinePipelineWatcherLogs5DE54482:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Join:
          - ""
          - - /aws/lambda/
            - Ref: CodeCommitPipelinePipelineWatcherPoller5C65ACDE
      RetentionInDays: 731
    DeletionPolicy: Retain
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/Logs/Resource
  CodeCommitPipelinePipelineWatcherTriggerA38A4AD0:
    Type: AWS::Events::Rule
    Properties:
      ScheduleExpression: rate(1 minute)
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - CodeCommitPipelinePipelineWatcherPoller5C65ACDE
              - Arn
          Id: Poller
    DependsOn:
      - CodeCommitPipelinePipelineWatcherLogs5DE54482
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/Trigger/Resource
  CodeCommitPipelinePipelineWatcherMetricFilter1D1A0C4D:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: '{ $.failedCount = "*" }'
      LogGroupName:
        Ref: CodeCommitPipelinePipelineWatcherLogs5DE54482
      MetricTransformations:
        - MetricName:
            Fn::Join:
              - ""
              - - Ref: CodeCommitPipelineBuildPipeline656B8CCB
                - _FailedStages
          MetricNamespace: CDK/Delivlib
          MetricValue: $.failedCount
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/MetricFilter/Resource
  CodeCommitPipelinePipelineWatcherAlarm73779F48:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Threshold: 1
      AlarmDescription: Pipeline aws-delivlib test pipeline has failed stages
      MetricName:
        Fn::Join:
          - ""
          - - Ref: CodeCommitPipelineBuildPipeline656B8CCB
            - _FailedStages
      Namespace: CDK/Delivlib
      Period: 300
      Statistic: Maximum
      TreatMissingData: ignore
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/Alarm/Resource
  CodeCommitPipelineHelloLinuxRoleFA5AA729:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloLinux/Resource/Resource/Role/Resource
  CodeCommitPipelineHelloLinuxRoleDefaultPolicy08A1DE35:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineHelloLinux82ECC4D2
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineHelloLinux82ECC4D2
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineHelloLinuxScriptDirectoryS3Bucket1CA6FAFD
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineHelloLinuxScriptDirectoryS3Bucket1CA6FAFD
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineHelloLinuxScriptDirectoryS3VersionKey1E4A3291
                    - "*"
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineHelloLinuxRoleDefaultPolicy08A1DE35
      Roles:
        - Ref: CodeCommitPipelineHelloLinuxRoleFA5AA729
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloLinux/Resource/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineHelloLinux82ECC4D2:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineHelloLinuxScriptDirectoryS3Bucket1CA6FAFD
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineHelloLinuxScriptDirectoryS3VersionKey1E4A3291
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineHelloLinuxScriptDirectoryS3VersionKey1E4A3291
        Image: aws/codebuild/ubuntu-base:14.04
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineHelloLinuxRoleFA5AA729
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                  "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                  "mkdir -p /tmp/scriptdir",
                  "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir"
                ]
              },
              "build": {
                "commands": [
                  "export SCRIPT_DIR=/tmp/scriptdir",
                  "echo \"Running test.sh\"",
                  "/bin/bash /tmp/scriptdir/test.sh"
                ]
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloLinux/Resource/Resource/Resource
  CodeCommitPipelineHelloLinuxOnBuildFailedD1EEA29A:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.codebuild
        detail-type:
          - CodeBuild Build State Change
        detail:
          project-name:
            - Ref: CodeCommitPipelineHelloLinux82ECC4D2
          build-status:
            - FAILED
      State: ENABLED
      Targets:
        - Arn:
            Ref: CodeCommitPipelineNotificationsTopic36C2D667
          Id: NotificationsTopic
          InputTransformer:
            InputTemplate: '"Test HelloLinux failed"'
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloLinux/Resource/Resource/OnBuildFailed/Resource
  CodeCommitPipelineHelloWindowsRole1F446E70:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloWindows/Resource/Resource/Role/Resource
  CodeCommitPipelineHelloWindowsRoleDefaultPolicy94524A3B:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineHelloWindows397414E5
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineHelloWindows397414E5
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineHelloWindowsScriptDirectoryS3BucketE5455B35
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineHelloWindowsScriptDirectoryS3BucketE5455B35
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineHelloWindowsScriptDirectoryS3VersionKey85D66DB9
                    - "*"
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineHelloWindowsRoleDefaultPolicy94524A3B
      Roles:
        - Ref: CodeCommitPipelineHelloWindowsRole1F446E70
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloWindows/Resource/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineHelloWindows397414E5:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineHelloWindowsScriptDirectoryS3BucketE5455B35
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineHelloWindowsScriptDirectoryS3VersionKey85D66DB9
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineHelloWindowsScriptDirectoryS3VersionKey85D66DB9
        Image: aws/codebuild/windows-base:1.0
        PrivilegedMode: false
        Type: WINDOWS_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineHelloWindowsRole1F446E70
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": []
              },
              "build": {
                "commands": [
                  "Set-Variable -Name TEMPDIR -Value (New-TemporaryFile).DirectoryName",
                  "aws s3 cp s3://$env:SCRIPT_S3_BUCKET/$env:SCRIPT_S3_KEY $TEMPDIR\\scripts.zip",
                  "New-Item -ItemType Directory -Path $TEMPDIR\\scriptdir",
                  "Expand-Archive -Path $TEMPDIR/scripts.zip -DestinationPath $TEMPDIR\\scriptdir",
                  "$env:SCRIPT_DIR = \"$TEMPDIR\\scriptdir\"",
                  "& $TEMPDIR\\scriptdir\\test.ps1"
                ]
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloWindows/Resource/Resource/Resource
  CodeCommitPipelineHelloWindowsOnBuildFailed0BED9349:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.codebuild
        detail-type:
          - CodeBuild Build State Change
        detail:
          project-name:
            - Ref: CodeCommitPipelineHelloWindows397414E5
          build-status:
            - FAILED
      State: ENABLED
      Targets:
        - Arn:
            Ref: CodeCommitPipelineNotificationsTopic36C2D667
          Id: NotificationsTopic
          InputTransformer:
            InputTemplate: '"Test HelloWindows failed"'
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloWindows/Resource/Resource/OnBuildFailed/Resource
  CodeCommitPipelineNpmRole219D5F49:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/Npm/Default/Resource/Role/Resource
  CodeCommitPipelineNpmRoleDefaultPolicy1AFB68F0:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineNpm0D31AEFC
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineNpm0D31AEFC
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineNpmScriptDirectoryS3BucketFC1B4A74
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineNpmScriptDirectoryS3BucketFC1B4A74
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineNpmScriptDirectoryS3VersionKey007F90CF
                    - "*"
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/npm-OynG62
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineNpmRoleDefaultPolicy1AFB68F0
      Roles:
        - Ref: CodeCommitPipelineNpmRole219D5F49
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/Npm/Default/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineNpm0D31AEFC:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineNpmScriptDirectoryS3BucketFC1B4A74
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineNpmScriptDirectoryS3VersionKey007F90CF
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineNpmScriptDirectoryS3VersionKey007F90CF
          - Name: FOR_REAL
            Type: PLAINTEXT
            Value: "true"
          - Name: NPM_TOKEN_SECRET
            Type: PLAINTEXT
            Value: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/npm-OynG62
        Image: aws/codebuild/nodejs:10.1.0
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineNpmRole219D5F49
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                  "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                  "mkdir -p /tmp/scriptdir",
                  "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir"
                ]
              },
              "build": {
                "commands": [
                  "export SCRIPT_DIR=/tmp/scriptdir",
                  "echo \"Running publish.sh\"",
                  "/bin/bash /tmp/scriptdir/publish.sh"
                ]
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/Npm/Default/Resource/Resource
  CodeCommitPipelineNuGetRole488DA302:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/NuGet/Default/Resource/Role/Resource
  CodeCommitPipelineNuGetRoleDefaultPolicy9AF66D81:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineNuGet67CE1BA7
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineNuGet67CE1BA7
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineNuGetScriptDirectoryS3Bucket3EE4493E
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineNuGetScriptDirectoryS3Bucket3EE4493E
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineNuGetScriptDirectoryS3VersionKeyA319F624
                    - "*"
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/nuget-fHzSUD
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - X509CodeSigningKeyRSAPrivateKeyE5980A70
                - SecretArn
          - Action: ssm:GetParameter
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":ssm:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :parameter/delivlib-test/X509CodeSigningKey/Certificate
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineNuGetRoleDefaultPolicy9AF66D81
      Roles:
        - Ref: CodeCommitPipelineNuGetRole488DA302
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/NuGet/Default/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineNuGet67CE1BA7:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineNuGetScriptDirectoryS3Bucket3EE4493E
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineNuGetScriptDirectoryS3VersionKeyA319F624
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineNuGetScriptDirectoryS3VersionKeyA319F624
          - Name: FOR_REAL
            Type: PLAINTEXT
            Value: "true"
          - Name: NUGET_SECRET_REGION
            Type: PLAINTEXT
            Value:
              Ref: AWS::Region
          - Name: NUGET_SECRET_ID
            Type: PLAINTEXT
            Value: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/nuget-fHzSUD
          - Name: CODE_SIGNING_SECRET_ID
            Type: PLAINTEXT
            Value:
              Fn::GetAtt:
                - X509CodeSigningKeyRSAPrivateKeyE5980A70
                - SecretArn
          - Name: CODE_SIGNING_PARAMETER_NAME
            Type: PLAINTEXT
            Value: /delivlib-test/X509CodeSigningKey/Certificate
        Image: aws/codebuild/dot-net:core-2.1
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineNuGetRole488DA302
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                  "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                  "mkdir -p /tmp/scriptdir",
                  "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir"
                ]
              },
              "build": {
                "commands": [
                  "export SCRIPT_DIR=/tmp/scriptdir",
                  "echo \"Running publish.sh\"",
                  "/bin/bash /tmp/scriptdir/publish.sh"
                ]
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/NuGet/Default/Resource/Resource
  CodeCommitPipelineMavenRoleC3A7769B:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/Maven/Default/Resource/Role/Resource
  CodeCommitPipelineMavenRoleDefaultPolicyBCD15357:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineMavenB7154296
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineMavenB7154296
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineMavenScriptDirectoryS3Bucket8BD14FB0
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineMavenScriptDirectoryS3Bucket8BD14FB0
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineMavenScriptDirectoryS3VersionKey8E6343D1
                    - "*"
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/maven-7ROCWi
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeSignSecretF6FDE552
                - SecretArn
          - Action: kms:Decrypt
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeSignKey2302B99A
                - Arn
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineMavenRoleDefaultPolicyBCD15357
      Roles:
        - Ref: CodeCommitPipelineMavenRoleC3A7769B
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/Maven/Default/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineMavenB7154296:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineMavenScriptDirectoryS3Bucket8BD14FB0
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineMavenScriptDirectoryS3VersionKey8E6343D1
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineMavenScriptDirectoryS3VersionKey8E6343D1
          - Name: STAGING_PROFILE_ID
            Type: PLAINTEXT
            Value: 68a05363083174
          - Name: SIGNING_KEY_SCOPE
            Type: PLAINTEXT
            Value: delivlib-test/CodeSign
          - Name: FOR_REAL
            Type: PLAINTEXT
            Value: "true"
          - Name: MAVEN_LOGIN_SECRET
            Type: PLAINTEXT
            Value: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/maven-7ROCWi
        Image: aws/codebuild/nodejs:10.1.0
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineMavenRoleC3A7769B
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                  "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                  "mkdir -p /tmp/scriptdir",
                  "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir"
                ]
              },
              "build": {
                "commands": [
                  "export SCRIPT_DIR=/tmp/scriptdir",
                  "echo \"Running publish.sh\"",
                  "/bin/bash /tmp/scriptdir/publish.sh"
                ]
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/Maven/Default/Resource/Resource
  CodeCommitPipelineGitHubRole77F2217D:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GitHub/Default/Resource/Role/Resource
  CodeCommitPipelineGitHubRoleDefaultPolicy3FEA7E07:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineGitHub0797840C
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineGitHub0797840C
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineGitHubScriptDirectoryS3Bucket0F36AC0A
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineGitHubScriptDirectoryS3Bucket0F36AC0A
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineGitHubScriptDirectoryS3VersionKey1C039B7C
                    - "*"
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeSignSecretF6FDE552
                - SecretArn
          - Action: kms:Decrypt
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeSignKey2302B99A
                - Arn
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineGitHubRoleDefaultPolicy3FEA7E07
      Roles:
        - Ref: CodeCommitPipelineGitHubRole77F2217D
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GitHub/Default/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineGitHub0797840C:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineGitHubScriptDirectoryS3Bucket0F36AC0A
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineGitHubScriptDirectoryS3VersionKey1C039B7C
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineGitHubScriptDirectoryS3VersionKey1C039B7C
          - Name: BUILD_MANIFEST
            Type: PLAINTEXT
            Value: ./build.json
          - Name: CHANGELOG
            Type: PLAINTEXT
            Value: ./CHANGELOG.md
          - Name: SIGNING_KEY_SCOPE
            Type: PLAINTEXT
            Value: delivlib-test/CodeSign
          - Name: GITHUB_TOKEN
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineGitHubGitHubTokenParameterA51FA80C
          - Name: GITHUB_OWNER
            Type: PLAINTEXT
            Value: awslabs
          - Name: GITHUB_REPO
            Type: PLAINTEXT
            Value: aws-delivlib-sample
          - Name: FOR_REAL
            Type: PLAINTEXT
            Value: "true"
        Image: aws/codebuild/nodejs:10.1.0
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineGitHubRole77F2217D
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                  "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                  "mkdir -p /tmp/scriptdir",
                  "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir"
                ]
              },
              "build": {
                "commands": [
                  "export SCRIPT_DIR=/tmp/scriptdir",
                  "echo \"Running publish.sh\"",
                  "/bin/bash /tmp/scriptdir/publish.sh"
                ]
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GitHub/Default/Resource/Resource
  CodeCommitPipelineGitHubPagesRole10784D1D:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GitHubPages/Default/Resource/Role/Resource
  CodeCommitPipelineGitHubPagesRoleDefaultPolicy23292E7F:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineGitHubPages53B77CF6
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineGitHubPages53B77CF6
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineGitHubPagesScriptDirectoryS3BucketFC75D454
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineGitHubPagesScriptDirectoryS3BucketFC75D454
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineGitHubPagesScriptDirectoryS3VersionKey5CE2FF2C
                    - "*"
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/github-ssh-lwzfjW
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineGitHubPagesRoleDefaultPolicy23292E7F
      Roles:
        - Ref: CodeCommitPipelineGitHubPagesRole10784D1D
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GitHubPages/Default/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineGitHubPages53B77CF6:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineGitHubPagesScriptDirectoryS3BucketFC75D454
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineGitHubPagesScriptDirectoryS3VersionKey5CE2FF2C
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineGitHubPagesScriptDirectoryS3VersionKey5CE2FF2C
          - Name: GITHUB_REPO
            Type: PLAINTEXT
            Value: git@github.com:awslabs/aws-delivlib-sample
          - Name: GITHUB_PAGES_BRANCH
            Type: PLAINTEXT
            Value: gh-pages
          - Name: SSH_KEY_SECRET
            Type: PLAINTEXT
            Value: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/github-ssh-lwzfjW
          - Name: FOR_REAL
            Type: PLAINTEXT
            Value: "true"
          - Name: COMMIT_USERNAME
            Type: PLAINTEXT
            Value: foobar
          - Name: COMMIT_EMAIL
            Type: PLAINTEXT
            Value: foo@bar.com
          - Name: BUILD_MANIFEST
            Type: PLAINTEXT
            Value: ./build.json
        Image: aws/codebuild/nodejs:10.1.0
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineGitHubPagesRole10784D1D
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                  "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                  "mkdir -p /tmp/scriptdir",
                  "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir"
                ]
              },
              "build": {
                "commands": [
                  "export SCRIPT_DIR=/tmp/scriptdir",
                  "echo \"Running publish.sh\"",
                  "/bin/bash /tmp/scriptdir/publish.sh"
                ]
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GitHubPages/Default/Resource/Resource
  AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62cServiceRoleD788AA17:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: delivlib-test/AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62c/ServiceRole/Resource
  AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62cServiceRoleDefaultPolicy6BC8737C:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - ecr:GetRepositoryPolicy
              - ecr:SetRepositoryPolicy
              - ecr:DeleteRepository
              - ecr:ListImages
              - ecr:BatchDeleteImage
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":ecr:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :repository/
                  - Fn::Select:
                      - 0
                      - Fn::Split:
                          - ":"
                          - Ref: CodeCommitPipelinesuperchainImageNameF1669FD4
        Version: "2012-10-17"
      PolicyName: AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62cServiceRoleDefaultPolicy6BC8737C
      Roles:
        - Ref: AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62cServiceRoleD788AA17
    Metadata:
      aws:cdk:path: delivlib-test/AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62c/ServiceRole/DefaultPolicy/Resource
  AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62c52BE89E9:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62cCodeS3Bucket92AB06B6
        S3Key:
          Fn::Join:
            - ""
            - - Fn::Select:
                  - 0
                  - Fn::Split:
                      - "||"
                      - Ref: AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62cCodeS3VersionKey393B7276
              - Fn::Select:
                  - 1
                  - Fn::Split:
                      - "||"
                      - Ref: AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62cCodeS3VersionKey393B7276
      Handler: handler.handler
      Role:
        Fn::GetAtt:
          - AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62cServiceRoleD788AA17
          - Arn
      Runtime: nodejs8.10
      Timeout: 300
    DependsOn:
      - AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62cServiceRoleD788AA17
      - AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62cServiceRoleDefaultPolicy6BC8737C
    Metadata:
      aws:cdk:path: delivlib-test/AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62c/Resource
  X509CodeSigningKeyRSAPrivateKeyE5980A70:
    Type: Custom::RsaPrivateKeySecret
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - SingletonLambda72FD327D38134632934028EC437AA4865ADA6EFF
          - Arn
      ResourceVersion: D814CuqbbboiuJN5/X3Z+0jTDSRIV+YFxOduP5eJEmo=
      Description: The PEM-encoded private key of the x509 Code-Signing Certificate
      KeySize: 2048
      SecretName: delivlib-test/X509CodeSigningKey/RSAPrivateKey
    DependsOn:
      - SingletonLambda72FD327D38134632934028EC437AA486ServiceRole225F46F5
      - SingletonLambda72FD327D38134632934028EC437AA486ServiceRoleDefaultPolicy77701415
    DeletionPolicy: Retain
    Metadata:
      aws:cdk:path: delivlib-test/X509CodeSigningKey/RSAPrivateKey/Resource
  X509CodeSigningKeyRSAPrivateKeyCertificateSigningRequest7F706C9D:
    Type: Custom::CertificateSigningRequest
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - CreateCSR541F67826DCF49A78C5A67715ADD9E4C8F4169F6
          - Arn
      ResourceVersion: I2WXTF1ul/g/BWPxr7MIHTYwK9pt3eiKV0H2BMZ5yRc=
      PrivateKeySecretId:
        Fn::GetAtt:
          - X509CodeSigningKeyRSAPrivateKeyE5980A70
          - SecretArn
      PrivateKeySecretVersion:
        Fn::GetAtt:
          - X509CodeSigningKeyRSAPrivateKeyE5980A70
          - SecretVersionId
      DnCommonName: delivlib-test
      DnCountry: IL
      DnStateOrProvince: Ztate
      DnLocality: Zity
      DnOrganizationName: Amazon Test
      DnOrganizationalUnitName: AWS
      DnEmailAddress: aws-cdk-dev+delivlib-test@amazon.com
      ExtendedKeyUsage: critical,codeSigning
      KeyUsage: critical,digitalSignature
    DependsOn:
      - CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleD2990C92
      - CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleDefaultPolicyC0800208
    Metadata:
      aws:cdk:path: delivlib-test/X509CodeSigningKey/RSAPrivateKey/CertificateSigningRequest/Resource
  X509CodeSigningKey46995D64:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Value:
        Fn::GetAtt:
          - X509CodeSigningKeyRSAPrivateKeyCertificateSigningRequest7F706C9D
          - SelfSignedCertificate
      Description:
        Fn::Join:
          - ""
          - - "A PEM-encoded Code-Signing Certificate (private key in "
            - Fn::GetAtt:
                - X509CodeSigningKeyRSAPrivateKeyE5980A70
                - SecretArn
            - " version "
            - Fn::GetAtt:
                - X509CodeSigningKeyRSAPrivateKeyE5980A70
                - SecretVersionId
            - )
      Name: /delivlib-test/X509CodeSigningKey/Certificate
    Metadata:
      aws:cdk:path: delivlib-test/X509CodeSigningKey/Resource
  SingletonLambda72FD327D38134632934028EC437AA486ServiceRole225F46F5:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: delivlib-test/SingletonLambda72FD327D38134632934028EC437AA486/ServiceRole/Resource
  SingletonLambda72FD327D38134632934028EC437AA486ServiceRoleDefaultPolicy77701415:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - secretsmanager:CreateSecret
              - secretsmanager:DeleteSecret
              - secretsmanager:ListSecretVersionIds
              - secretsmanager:UpdateSecret
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":secretsmanager:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :secret:delivlib-test/X509CodeSigningKey/RSAPrivateKey-??????
        Version: "2012-10-17"
      PolicyName: SingletonLambda72FD327D38134632934028EC437AA486ServiceRoleDefaultPolicy77701415
      Roles:
        - Ref: SingletonLambda72FD327D38134632934028EC437AA486ServiceRole225F46F5
    Metadata:
      aws:cdk:path: delivlib-test/SingletonLambda72FD327D38134632934028EC437AA486/ServiceRole/DefaultPolicy/Resource
  SingletonLambda72FD327D38134632934028EC437AA4865ADA6EFF:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: SingletonLambda72FD327D38134632934028EC437AA486CodeS3BucketE07F4BCB
        S3Key:
          Fn::Join:
            - ""
            - - Fn::Select:
                  - 0
                  - Fn::Split:
                      - "||"
                      - Ref: SingletonLambda72FD327D38134632934028EC437AA486CodeS3VersionKeyF016F0F7
              - Fn::Select:
                  - 1
                  - Fn::Split:
                      - "||"
                      - Ref: SingletonLambda72FD327D38134632934028EC437AA486CodeS3VersionKeyF016F0F7
      Handler: index.handler
      Role:
        Fn::GetAtt:
          - SingletonLambda72FD327D38134632934028EC437AA486ServiceRole225F46F5
          - Arn
      Runtime: nodejs8.10
      Description: Generates an RSA Private Key and stores it in AWS Secrets Manager
      Timeout: 300
    DependsOn:
      - SingletonLambda72FD327D38134632934028EC437AA486ServiceRole225F46F5
      - SingletonLambda72FD327D38134632934028EC437AA486ServiceRoleDefaultPolicy77701415
    Metadata:
      aws:cdk:path: delivlib-test/SingletonLambda72FD327D38134632934028EC437AA486/Resource
  CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleD2990C92:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: delivlib-test/CreateCSR541F67826DCF49A78C5A67715ADD9E4C/ServiceRole/Resource
  CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleDefaultPolicyC0800208:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: secretsmanager:GetSecretValue
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - X509CodeSigningKeyRSAPrivateKeyE5980A70
                - SecretArn
        Version: "2012-10-17"
      PolicyName: CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleDefaultPolicyC0800208
      Roles:
        - Ref: CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleD2990C92
    Metadata:
      aws:cdk:path: delivlib-test/CreateCSR541F67826DCF49A78C5A67715ADD9E4C/ServiceRole/DefaultPolicy/Resource
  CreateCSR541F67826DCF49A78C5A67715ADD9E4C8F4169F6:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: CreateCSR541F67826DCF49A78C5A67715ADD9E4CCodeS3Bucket45923B19
        S3Key:
          Fn::Join:
            - ""
            - - Fn::Select:
                  - 0
                  - Fn::Split:
                      - "||"
                      - Ref: CreateCSR541F67826DCF49A78C5A67715ADD9E4CCodeS3VersionKey9D63F460
              - Fn::Select:
                  - 1
                  - Fn::Split:
                      - "||"
                      - Ref: CreateCSR541F67826DCF49A78C5A67715ADD9E4CCodeS3VersionKey9D63F460
      Handler: index.handler
      Role:
        Fn::GetAtt:
          - CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleD2990C92
          - Arn
      Runtime: nodejs8.10
      Description: Creates a Certificate Signing Request document for an x509 certificate
      Timeout: 300
    DependsOn:
      - CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleD2990C92
      - CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleDefaultPolicyC0800208
    Metadata:
      aws:cdk:path: delivlib-test/CreateCSR541F67826DCF49A78C5A67715ADD9E4C/Resource
  CodeSignKey2302B99A:
    Type: AWS::KMS::Key
    Properties:
      KeyPolicy:
        Statement:
          - Action:
              - kms:Create*
              - kms:Describe*
              - kms:Enable*
              - kms:List*
              - kms:Put*
              - kms:Update*
              - kms:Revoke*
              - kms:Disable*
              - kms:Get*
              - kms:Delete*
              - kms:ScheduleKeyDeletion
              - kms:CancelKeyDeletion
            Effect: Allow
            Principal:
              AWS:
                Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":iam::"
                    - Ref: AWS::AccountId
                    - :root
            Resource: "*"
          - Action:
              - kms:GenerateDataKey
              - kms:Encrypt
              - kms:Decrypt
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                  - SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRole410148CF
                  - Arn
            Resource: "*"
          - Action: kms:Decrypt
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                  - CodeCommitPipelineMavenRoleC3A7769B
                  - Arn
            Resource: "*"
          - Action: kms:Decrypt
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                  - CodeCommitPipelineGitHubRole77F2217D
                  - Arn
            Resource: "*"
        Version: "2012-10-17"
      Description: Encryption key for PGP secret delivlib-test/CodeSign/SigningKey
    DeletionPolicy: Retain
    Metadata:
      aws:cdk:path: delivlib-test/CodeSign/Key/Resource
  CodeSignKeyAliasCEA10CD5:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: alias/delivlib-test/CodeSign/SigningKeyKey
      TargetKeyId:
        Fn::GetAtt:
          - CodeSignKey2302B99A
          - Arn
    Metadata:
      aws:cdk:path: delivlib-test/CodeSign/Key/Alias/Resource
  CodeSignSecretF6FDE552:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - SingletonLambdaf25803d3054b44fc985f4860d7d6ee746203BDE6
          - Arn
      ResourceVersion: +SXY24n+9oQ12YNf59IL/WUOen+tUEeaWL3+I/totzo=
      Identity: aws-cdk-dev
      Email: aws-cdk-dev+delivlib@amazon.com
      Expiry: 4y
      KeySizeBits: 4096
      SecretName: delivlib-test/CodeSign/SigningKey
      KeyArn:
        Fn::GetAtt:
          - CodeSignKey2302B99A
          - Arn
      ParameterName: /delivlib-test/CodeSign/SigningKey.pub
      Version: 1
    Metadata:
      aws:cdk:path: delivlib-test/CodeSign/Secret/Resource
  SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRole410148CF:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: delivlib-test/SingletonLambdaf25803d3054b44fc985f4860d7d6ee74/ServiceRole/Resource
  SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRoleDefaultPolicyA8FDF5BD:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - secretsmanager:CreateSecret
              - secretsmanager:ListSecretVersionIds
              - secretsmanager:UpdateSecret
              - secretsmanager:DeleteSecret
              - ssm:PutParameter
              - ssm:DeleteParameter
            Effect: Allow
            Resource: "*"
          - Action:
              - kms:GenerateDataKey
              - kms:Encrypt
              - kms:Decrypt
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeSignKey2302B99A
                - Arn
        Version: "2012-10-17"
      PolicyName: SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRoleDefaultPolicyA8FDF5BD
      Roles:
        - Ref: SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRole410148CF
    Metadata:
      aws:cdk:path: delivlib-test/SingletonLambdaf25803d3054b44fc985f4860d7d6ee74/ServiceRole/DefaultPolicy/Resource
  SingletonLambdaf25803d3054b44fc985f4860d7d6ee746203BDE6:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: SingletonLambdaf25803d3054b44fc985f4860d7d6ee74CodeS3BucketAC499781
        S3Key:
          Fn::Join:
            - ""
            - - Fn::Select:
                  - 0
                  - Fn::Split:
                      - "||"
                      - Ref: SingletonLambdaf25803d3054b44fc985f4860d7d6ee74CodeS3VersionKey10D2DDF5
              - Fn::Select:
                  - 1
                  - Fn::Split:
                      - "||"
                      - Ref: SingletonLambdaf25803d3054b44fc985f4860d7d6ee74CodeS3VersionKey10D2DDF5
      Handler: index.handler
      Role:
        Fn::GetAtt:
          - SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRole410148CF
          - Arn
      Runtime: nodejs8.10
      Description: Generates an OpenPGP Key and stores the private key in Secrets Manager
        and the public key in an SSM Parameter
      Timeout: 300
    DependsOn:
      - SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRole410148CF
      - SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRoleDefaultPolicyA8FDF5BD
    Metadata:
      aws:cdk:path: delivlib-test/SingletonLambdaf25803d3054b44fc985f4860d7d6ee74/Resource
Parameters:
  CodeCommitPipelineBuildPipelineGitHubTokenParameter9FBEDC6B:
    Type: AWS::SSM::Parameter::Value<String>
    Default: github-token
    NoEcho: true
  CodeCommitPipelinesuperchainImageNameF1669FD4:
    Type: String
    Description: ECR repository name and tag asset
      "delivlib-test/CodeCommitPipeline/superchain"
  CodeCommitPipelineHelloLinuxScriptDirectoryS3Bucket1CA6FAFD:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/HelloLinux/Resource/ScriptDirectory"
  CodeCommitPipelineHelloLinuxScriptDirectoryS3VersionKey1E4A3291:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/HelloLinux/Resource/ScriptDirectory"
  CodeCommitPipelineHelloWindowsScriptDirectoryS3BucketE5455B35:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/HelloWindows/Resource/ScriptDirectory"
  CodeCommitPipelineHelloWindowsScriptDirectoryS3VersionKey85D66DB9:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/HelloWindows/Resource/ScriptDirectory"
  CodeCommitPipelineNpmScriptDirectoryS3BucketFC1B4A74:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/Npm/Default/ScriptDirectory"
  CodeCommitPipelineNpmScriptDirectoryS3VersionKey007F90CF:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/Npm/Default/ScriptDirectory"
  CodeCommitPipelineNuGetScriptDirectoryS3Bucket3EE4493E:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/NuGet/Default/ScriptDirectory"
  CodeCommitPipelineNuGetScriptDirectoryS3VersionKeyA319F624:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/NuGet/Default/ScriptDirectory"
  CodeCommitPipelineMavenScriptDirectoryS3Bucket8BD14FB0:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/Maven/Default/ScriptDirectory"
  CodeCommitPipelineMavenScriptDirectoryS3VersionKey8E6343D1:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/Maven/Default/ScriptDirectory"
  CodeCommitPipelineGitHubGitHubTokenParameterA51FA80C:
    Type: AWS::SSM::Parameter::Value<String>
    Default: github-token
    NoEcho: true
  CodeCommitPipelineGitHubScriptDirectoryS3Bucket0F36AC0A:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/GitHub/Default/ScriptDirectory"
  CodeCommitPipelineGitHubScriptDirectoryS3VersionKey1C039B7C:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/GitHub/Default/ScriptDirectory"
  CodeCommitPipelineGitHubPagesScriptDirectoryS3BucketFC75D454:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/GitHubPages/Default/ScriptDirectory"
  CodeCommitPipelineGitHubPagesScriptDirectoryS3VersionKey5CE2FF2C:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/GitHubPages/Default/ScriptDirectory"
  AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62cCodeS3Bucket92AB06B6:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62c/Code"
  AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62cCodeS3VersionKey393B7276:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/AdoptEcrRepositorydbc60defc59544bcaa5c28c95d68f62c/Code"
  SingletonLambda72FD327D38134632934028EC437AA486CodeS3BucketE07F4BCB:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/SingletonLambda72FD327D38134632934028EC437AA486/Code"
  SingletonLambda72FD327D38134632934028EC437AA486CodeS3VersionKeyF016F0F7:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/SingletonLambda72FD327D38134632934028EC437AA486/Code"
  CreateCSR541F67826DCF49A78C5A67715ADD9E4CCodeS3Bucket45923B19:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CreateCSR541F67826DCF49A78C5A67715ADD9E4C/Code"
  CreateCSR541F67826DCF49A78C5A67715ADD9E4CCodeS3VersionKey9D63F460:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CreateCSR541F67826DCF49A78C5A67715ADD9E4C/Code"
  SingletonLambdaf25803d3054b44fc985f4860d7d6ee74CodeS3BucketAC499781:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/SingletonLambdaf25803d3054b44fc985f4860d7d6ee74/Code"
  SingletonLambdaf25803d3054b44fc985f4860d7d6ee74CodeS3VersionKey10D2DDF5:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/SingletonLambdaf25803d3054b44fc985f4860d7d6ee74/Code"
Outputs:
  X509CodeSigningKeyCSR5137C5A3:
    Description: A PEM-encoded Certificate Signing Request for a Code-Signing Certificate
    Value:
      Fn::GetAtt:
        - X509CodeSigningKeyRSAPrivateKeyCertificateSigningRequest7F706C9D
        - CSR

