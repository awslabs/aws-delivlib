Resources:
  CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildPipeline/ArtifactsBucket/Resource
  CodeCommitPipelineBuildPipelineRole1843599A:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildPipeline/Role/Resource
  CodeCommitPipelineBuildPipelineRoleDefaultPolicy94C30F44:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineBuildProject9F59E8AA
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineHelloLinuxCB82AB68
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineHelloWindows61CA8F73
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineAssumeRole05A76F51
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineGenerateTwoArtifactsA9DAD33B
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineNpm0D31AEFC
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineNuGet67CE1BA7
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineMavenB7154296
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineGitHub0797840C
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineGitHubPages53B77CF6
                - Arn
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelinePyPI2C59CE7B
                - Arn
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineBuildPipelineRoleDefaultPolicy94C30F44
      Roles:
        - Ref: CodeCommitPipelineBuildPipelineRole1843599A
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildPipeline/Role/DefaultPolicy/Resource
  CodeCommitPipelineBuildPipeline656B8CCB:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn:
        Fn::GetAtt:
          - CodeCommitPipelineBuildPipelineRole1843599A
          - Arn
      Stages:
        - Actions:
            - ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: "1"
              Configuration:
                Owner: awslabs
                Repo: aws-delivlib-sample
                Branch: master
                OAuthToken:
                  Ref: CodeCommitPipelineBuildPipelineGitHubTokenParameter9FBEDC6B
                PollForSourceChanges: false
              InputArtifacts: []
              Name: Pull
              OutputArtifacts:
                - Name: Source
              RunOrder: 1
          Name: Source
        - Actions:
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineBuildProject9F59E8AA
              InputArtifacts:
                - Name: Source
              Name: Build
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              RunOrder: 1
          Name: Build
        - Actions:
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineHelloLinuxCB82AB68
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: TestHelloLinux
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineHelloLinux01786D9D
              RunOrder: 1
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineHelloWindows61CA8F73
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: TestHelloWindows
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineHelloWindowsDD89E92A
              RunOrder: 1
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineAssumeRole05A76F51
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: TestAssumeRole
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineAssumeRole8CA58C9F
              RunOrder: 1
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineGenerateTwoArtifactsA9DAD33B
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: ActionGenerateTwoArtifacts
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineGenerateTwoArtifacts54497DAA
                - Name: artifact2
              RunOrder: 1
          Name: Test
        - Actions:
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineNpm0D31AEFC
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: NpmPublish
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineNpmNpmPublishF3497B8A
              RunOrder: 1
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineNuGet67CE1BA7
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: NuGetPublish
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineNuGetNuGetPublishD08C1873
              RunOrder: 1
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineMavenB7154296
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: MavenPublish
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineMavenMavenPublish23517E96
              RunOrder: 1
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineGitHub0797840C
                PrimarySource: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
                - Name: Artifact_delivlibtestCodeCommitPipelineGenerateTwoArtifacts54497DAA
                - Name: artifact2
              Name: GitHubPublish
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineGitHubGitHubPublish9C2DACED
              RunOrder: 1
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelineGitHubPages53B77CF6
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: GitHubPagesPublish
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineGitHubPagesGitHubPagesPublishCDA7CDC1
              RunOrder: 1
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CodeCommitPipelinePyPI2C59CE7B
              InputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelineBuildProjectBuildEB1D42D1
              Name: PyPIPublish
              OutputArtifacts:
                - Name: Artifact_delivlibtestCodeCommitPipelinePyPIPyPIPublishD455771C
              RunOrder: 1
          Name: Publish
      ArtifactStore:
        Location:
          Ref: CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
        Type: S3
      RestartExecutionOnUpdate: true
    DependsOn:
      - CodeCommitPipelineBuildPipelineRoleDefaultPolicy94C30F44
      - CodeCommitPipelineBuildPipelineRole1843599A
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildPipeline/Resource
  CodeCommitPipelineBuildPipelineSourcePullWebhookResource0898F523:
    Type: AWS::CodePipeline::Webhook
    Properties:
      Authentication: GITHUB_HMAC
      AuthenticationConfiguration:
        SecretToken:
          Ref: CodeCommitPipelineBuildPipelineGitHubTokenParameter9FBEDC6B
      Filters:
        - JsonPath: $.ref
          MatchEquals: refs/heads/{Branch}
      TargetAction: Pull
      TargetPipeline:
        Ref: CodeCommitPipelineBuildPipeline656B8CCB
      TargetPipelineVersion: 1
      RegisterWithThirdParty: true
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildPipeline/Source/Pull/WebhookResource
  CodeCommitPipelineBuildProjectRoleC6347B6E:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildProject/Role/Resource
  CodeCommitPipelineBuildProjectRoleDefaultPolicy1184486E:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineBuildProject9F59E8AA
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineBuildProject9F59E8AA
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineBuildProjectRoleDefaultPolicy1184486E
      Roles:
        - Ref: CodeCommitPipelineBuildProjectRoleC6347B6E
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildProject/Role/DefaultPolicy/Resource
  CodeCommitPipelineBuildProject9F59E8AA:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: jsii/superchain:latest
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineBuildProjectRoleC6347B6E
          - Arn
      Source:
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildProject/Resource
  CodeCommitPipelineBuildProjectOnBuildFailed2A08058D:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.codebuild
        detail-type:
          - CodeBuild Build State Change
        detail:
          project-name:
            - Ref: CodeCommitPipelineBuildProject9F59E8AA
          build-status:
            - FAILED
      State: ENABLED
      Targets:
        - Arn:
            Ref: CodeCommitPipelineNotificationsTopic36C2D667
          Id: NotificationsTopic
          InputTransformer:
            InputTemplate: '"aws-delivlib test pipeline build failed"'
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/BuildProject/OnBuildFailed/Resource
  CodeCommitPipelineNotificationsTopic36C2D667:
    Type: AWS::SNS::Topic
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/NotificationsTopic/Resource
  CodeCommitPipelineNotificationsTopicNotifyEmail146B339F:
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: aws-cdk-dev+delivlib-test@amazon.com
      Protocol: email
      TopicArn:
        Ref: CodeCommitPipelineNotificationsTopic36C2D667
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/NotificationsTopic/NotifyEmail/Resource
  CodeCommitPipelineNotificationsTopicPolicyBBE90C33:
    Type: AWS::SNS::TopicPolicy
    Properties:
      PolicyDocument:
        Statement:
          - Action: sns:Publish
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              Ref: CodeCommitPipelineNotificationsTopic36C2D667
            Sid: "0"
        Version: "2012-10-17"
      Topics:
        - Ref: CodeCommitPipelineNotificationsTopic36C2D667
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/NotificationsTopic/Policy/Resource
  CodeCommitPipelinePipelineWatcherPollerServiceRole0A1D8005:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/Poller/ServiceRole/Resource
  CodeCommitPipelinePipelineWatcherPollerServiceRoleDefaultPolicyE2104AD1:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: codepipeline:GetPipelineState
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":codepipeline:us-east-1:712950704752:"
                  - Ref: CodeCommitPipelineBuildPipeline656B8CCB
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelinePipelineWatcherPollerServiceRoleDefaultPolicyE2104AD1
      Roles:
        - Ref: CodeCommitPipelinePipelineWatcherPollerServiceRole0A1D8005
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/Poller/ServiceRole/DefaultPolicy/Resource
  CodeCommitPipelinePipelineWatcherPoller5C65ACDE:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        ZipFile: >-
          "use strict";

          Object.defineProperty(exports, "__esModule", { value: true });

          const AWS = require("aws-sdk");

          // export for tests

          exports.codePipeline = new AWS.CodePipeline();

          exports.logger = {
              log: (line) => process.stdout.write(line)
          };

          /**
           * Lambda function for checking the stages of a CodePipeline and emitting log
           * entries with { failedCount = <no. of failed stages> } for async metric
           * aggregation via metric filters.
           *
           * It requires the pipeline's name be set as the 'PIPELINE_NAME' environment variable.
           */
          async function handler() {
              const pipelineName = process.env.PIPELINE_NAME;
              if (!pipelineName) {
                  throw new Error("Pipeline name expects environment variable: 'PIPELINE_NAME'");
              }
              const state = await exports.codePipeline.getPipelineState({
                  name: pipelineName
              }).promise();
              let failedCount = 0;
              if (state.stageStates) {
                  failedCount = state.stageStates
                      .filter(stage => stage.latestExecution !== undefined && stage.latestExecution.status === 'Failed')
                      .length;
              }
              exports.logger.log(JSON.stringify({
                  failedCount
              }));
          }

          exports.handler = handler;

          //# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2F0Y2hlci1oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsid2F0Y2hlci1oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQWdDO0FBRWhDLG1CQUFtQjtBQUNOLFFBQUEsWUFBWSxHQUFHLElBQUksR0FBRyxDQUFDLFlBQVksRUFBRSxDQUFDO0FBQ3RDLFFBQUEsTUFBTSxHQUFHO0lBQ3BCLEdBQUcsRUFBRSxDQUFDLElBQVksRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO0NBQ2xELENBQUM7QUFFRjs7Ozs7O0dBTUc7QUFDSSxLQUFLLFVBQVUsT0FBTztJQUMzQixNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQztJQUMvQyxJQUFJLENBQUMsWUFBWSxFQUFFO1FBQ2pCLE1BQU0sSUFBSSxLQUFLLENBQUMsNkRBQTZELENBQUMsQ0FBQztLQUNoRjtJQUNELE1BQU0sS0FBSyxHQUFHLE1BQU0sb0JBQVksQ0FBQyxnQkFBZ0IsQ0FBQztRQUNoRCxJQUFJLEVBQUUsWUFBWTtLQUNuQixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7SUFFYixJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUM7SUFDcEIsSUFBSSxLQUFLLENBQUMsV0FBVyxFQUFFO1FBQ3JCLFdBQVcsR0FBRyxLQUFLLENBQUMsV0FBVzthQUM1QixNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsZUFBZSxLQUFLLFNBQVMsSUFBSSxLQUFLLENBQUMsZUFBZSxDQUFDLE1BQU0sS0FBSyxRQUFRLENBQUM7YUFDakcsTUFBTSxDQUFDO0tBQ1g7SUFDRCxjQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7UUFDeEIsV0FBVztLQUNaLENBQUMsQ0FBQyxDQUFDO0FBQ04sQ0FBQztBQWxCRCwwQkFrQkMifQ==
      Handler: index.handler
      Role:
        Fn::GetAtt:
          - CodeCommitPipelinePipelineWatcherPollerServiceRole0A1D8005
          - Arn
      Runtime: nodejs8.10
      Environment:
        Variables:
          PIPELINE_NAME:
            Ref: CodeCommitPipelineBuildPipeline656B8CCB
    DependsOn:
      - CodeCommitPipelinePipelineWatcherPollerServiceRoleDefaultPolicyE2104AD1
      - CodeCommitPipelinePipelineWatcherPollerServiceRole0A1D8005
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/Poller/Resource
  CodeCommitPipelinePipelineWatcherPollerAllowEventRuledelivlibtestCodeCommitPipelinePipelineWatcherTrigger0F55C26402F871FD:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: CodeCommitPipelinePipelineWatcherPoller5C65ACDE
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
          - CodeCommitPipelinePipelineWatcherTriggerA38A4AD0
          - Arn
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/Poller/AllowEventRuledelivlibtestCodeCommitPipelinePipelineWatcherTrigger0F55C264
  CodeCommitPipelinePipelineWatcherLogs5DE54482:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Join:
          - ""
          - - /aws/lambda/
            - Ref: CodeCommitPipelinePipelineWatcherPoller5C65ACDE
      RetentionInDays: 731
    DeletionPolicy: Retain
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/Logs/Resource
  CodeCommitPipelinePipelineWatcherTriggerA38A4AD0:
    Type: AWS::Events::Rule
    Properties:
      ScheduleExpression: rate(1 minute)
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - CodeCommitPipelinePipelineWatcherPoller5C65ACDE
              - Arn
          Id: Poller
    DependsOn:
      - CodeCommitPipelinePipelineWatcherLogs5DE54482
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/Trigger/Resource
  CodeCommitPipelinePipelineWatcherMetricFilter1D1A0C4D:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: '{ $.failedCount = "*" }'
      LogGroupName:
        Ref: CodeCommitPipelinePipelineWatcherLogs5DE54482
      MetricTransformations:
        - MetricName:
            Fn::Join:
              - ""
              - - Ref: CodeCommitPipelineBuildPipeline656B8CCB
                - _FailedStages
          MetricNamespace: CDK/Delivlib
          MetricValue: $.failedCount
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/MetricFilter/Resource
  CodeCommitPipelinePipelineWatcherAlarm73779F48:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Threshold: 1
      AlarmDescription: Pipeline aws-delivlib test pipeline has failed stages
      MetricName:
        Fn::Join:
          - ""
          - - Ref: CodeCommitPipelineBuildPipeline656B8CCB
            - _FailedStages
      Namespace: CDK/Delivlib
      Period: 300
      Statistic: Maximum
      TreatMissingData: ignore
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PipelineWatcher/Alarm/Resource
  CodeCommitPipelineHelloLinuxRole97734933:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloLinux/Resource/Role/Resource
  CodeCommitPipelineHelloLinuxRoleDefaultPolicy234DABC6:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineHelloLinuxCB82AB68
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineHelloLinuxCB82AB68
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineHelloLinuxScriptDirectoryS3Bucket56DFBFCD
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineHelloLinuxScriptDirectoryS3Bucket56DFBFCD
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineHelloLinuxScriptDirectoryS3VersionKey0036B1AA
                    - "*"
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineHelloLinuxRoleDefaultPolicy234DABC6
      Roles:
        - Ref: CodeCommitPipelineHelloLinuxRole97734933
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloLinux/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineHelloLinuxCB82AB68:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineHelloLinuxScriptDirectoryS3Bucket56DFBFCD
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineHelloLinuxScriptDirectoryS3VersionKey0036B1AA
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineHelloLinuxScriptDirectoryS3VersionKey0036B1AA
        Image: aws/codebuild/ubuntu-base:14.04
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineHelloLinuxRole97734933
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                  "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                  "mkdir -p /tmp/scriptdir",
                  "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir"
                ]
              },
              "build": {
                "commands": [
                  "export SCRIPT_DIR=/tmp/scriptdir",
                  "echo \"Running test.sh\"",
                  "/bin/bash /tmp/scriptdir/test.sh"
                ]
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloLinux/Resource/Resource
  CodeCommitPipelineHelloLinuxOnBuildFailedD96AF043:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.codebuild
        detail-type:
          - CodeBuild Build State Change
        detail:
          project-name:
            - Ref: CodeCommitPipelineHelloLinuxCB82AB68
          build-status:
            - FAILED
      State: ENABLED
      Targets:
        - Arn:
            Ref: CodeCommitPipelineNotificationsTopic36C2D667
          Id: NotificationsTopic
          InputTransformer:
            InputTemplate: '"Test HelloLinux failed"'
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloLinux/Resource/OnBuildFailed/Resource
  CodeCommitPipelineHelloLinuxAlarmE81F4D20:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Threshold: 1
      Dimensions:
        - Name: ProjectName
          Value:
            Ref: CodeCommitPipelineHelloLinuxCB82AB68
      MetricName: FailedBuilds
      Namespace: AWS/CodeBuild
      Period: 300
      Statistic: Sum
      TreatMissingData: ignore
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloLinux/Alarm/Resource
  CodeCommitPipelineHelloWindowsRole769C073E:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloWindows/Resource/Role/Resource
  CodeCommitPipelineHelloWindowsRoleDefaultPolicyA240EEEE:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineHelloWindows61CA8F73
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineHelloWindows61CA8F73
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineHelloWindowsScriptDirectoryS3Bucket368E02F9
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineHelloWindowsScriptDirectoryS3Bucket368E02F9
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineHelloWindowsScriptDirectoryS3VersionKey00CFAE1A
                    - "*"
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineHelloWindowsRoleDefaultPolicyA240EEEE
      Roles:
        - Ref: CodeCommitPipelineHelloWindowsRole769C073E
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloWindows/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineHelloWindows61CA8F73:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineHelloWindowsScriptDirectoryS3Bucket368E02F9
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineHelloWindowsScriptDirectoryS3VersionKey00CFAE1A
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineHelloWindowsScriptDirectoryS3VersionKey00CFAE1A
        Image: aws/codebuild/windows-base:1.0
        PrivilegedMode: false
        Type: WINDOWS_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineHelloWindowsRole769C073E
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": []
              },
              "build": {
                "commands": [
                  "Set-Variable -Name TEMPDIR -Value (New-TemporaryFile).DirectoryName",
                  "aws s3 cp s3://$env:SCRIPT_S3_BUCKET/$env:SCRIPT_S3_KEY $TEMPDIR\\scripts.zip",
                  "New-Item -ItemType Directory -Path $TEMPDIR\\scriptdir",
                  "Expand-Archive -Path $TEMPDIR/scripts.zip -DestinationPath $TEMPDIR\\scriptdir",
                  "$env:SCRIPT_DIR = \"$TEMPDIR\\scriptdir\"",
                  "& $TEMPDIR\\scriptdir\\test.ps1"
                ]
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloWindows/Resource/Resource
  CodeCommitPipelineHelloWindowsOnBuildFailed25F55C59:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.codebuild
        detail-type:
          - CodeBuild Build State Change
        detail:
          project-name:
            - Ref: CodeCommitPipelineHelloWindows61CA8F73
          build-status:
            - FAILED
      State: ENABLED
      Targets:
        - Arn:
            Ref: CodeCommitPipelineNotificationsTopic36C2D667
          Id: NotificationsTopic
          InputTransformer:
            InputTemplate: '"Test HelloWindows failed"'
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloWindows/Resource/OnBuildFailed/Resource
  CodeCommitPipelineHelloWindowsAlarmB6D353FA:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Threshold: 1
      Dimensions:
        - Name: ProjectName
          Value:
            Ref: CodeCommitPipelineHelloWindows61CA8F73
      MetricName: FailedBuilds
      Namespace: AWS/CodeBuild
      Period: 300
      Statistic: Sum
      TreatMissingData: ignore
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/HelloWindows/Alarm/Resource
  CodeCommitPipelineAssumeRoleRole1186B781:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/AssumeRole/Resource/Role/Resource
  CodeCommitPipelineAssumeRoleRoleDefaultPolicy438D80DD:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineAssumeRole05A76F51
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineAssumeRole05A76F51
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineAssumeRoleScriptDirectoryS3Bucket019558B4
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineAssumeRoleScriptDirectoryS3Bucket019558B4
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineAssumeRoleScriptDirectoryS3VersionKeyC04C2FE1
                    - "*"
          - Action: sts:AssumeRole
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - AssumeMe924099BB
                - Arn
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineAssumeRoleRoleDefaultPolicy438D80DD
      Roles:
        - Ref: CodeCommitPipelineAssumeRoleRole1186B781
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/AssumeRole/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineAssumeRole05A76F51:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineAssumeRoleScriptDirectoryS3Bucket019558B4
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineAssumeRoleScriptDirectoryS3VersionKeyC04C2FE1
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineAssumeRoleScriptDirectoryS3VersionKeyC04C2FE1
          - Name: EXPECTED_ROLE_NAME
            Type: PLAINTEXT
            Value:
              Ref: AssumeMe924099BB
        Image: aws/codebuild/ubuntu-base:14.04
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineAssumeRoleRole1186B781
          - Arn
      Source:
        BuildSpec:
          Fn::Join:
            - ""
            - - >-
                {
                  "version": "0.2",
                  "phases": {
                    "pre_build": {
                      "commands": [
                        "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                        "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                        "mkdir -p /tmp/scriptdir",
                        "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir",
                        "creds=$(mktemp -d)/creds.json",
                        "aws sts assume-role --role-arn \"
              - Fn::GetAtt:
                  - AssumeMe924099BB
                  - Arn
              - >-
                \" --role-session-name \"assume-role-test\" --external-id
                \"require-me-please\" > $creds",
                        "export AWS_ACCESS_KEY_ID=\"$(cat ${creds} | grep \"AccessKeyId\" | cut -d'\"' -f 4)\"",
                        "export AWS_SECRET_ACCESS_KEY=\"$(cat ${creds} | grep \"SecretAccessKey\" | cut -d'\"' -f 4)\"",
                        "export AWS_SESSION_TOKEN=\"$(cat ${creds} | grep \"SessionToken\" | cut -d'\"' -f 4)\""
                      ]
                    },
                    "build": {
                      "commands": [
                        "export SCRIPT_DIR=/tmp/scriptdir",
                        "echo \"Running test.sh\"",
                        "/bin/bash /tmp/scriptdir/test.sh"
                      ]
                    }
                  }
                }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/AssumeRole/Resource/Resource
  CodeCommitPipelineAssumeRoleOnBuildFailed494CD87B:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.codebuild
        detail-type:
          - CodeBuild Build State Change
        detail:
          project-name:
            - Ref: CodeCommitPipelineAssumeRole05A76F51
          build-status:
            - FAILED
      State: ENABLED
      Targets:
        - Arn:
            Ref: CodeCommitPipelineNotificationsTopic36C2D667
          Id: NotificationsTopic
          InputTransformer:
            InputTemplate: '"Test AssumeRole failed"'
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/AssumeRole/Resource/OnBuildFailed/Resource
  CodeCommitPipelineAssumeRoleAlarm6D09484D:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Threshold: 1
      Dimensions:
        - Name: ProjectName
          Value:
            Ref: CodeCommitPipelineAssumeRole05A76F51
      MetricName: FailedBuilds
      Namespace: AWS/CodeBuild
      Period: 300
      Statistic: Sum
      TreatMissingData: ignore
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/AssumeRole/Alarm/Resource
  CodeCommitPipelineGenerateTwoArtifactsRole91D2CDCA:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GenerateTwoArtifacts/Resource/Role/Resource
  CodeCommitPipelineGenerateTwoArtifactsRoleDefaultPolicy770BE7EA:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineGenerateTwoArtifactsA9DAD33B
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineGenerateTwoArtifactsA9DAD33B
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineGenerateTwoArtifactsScriptDirectoryS3BucketE058B7EF
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineGenerateTwoArtifactsScriptDirectoryS3BucketE058B7EF
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineGenerateTwoArtifactsScriptDirectoryS3VersionKeyD775EF3D
                    - "*"
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineGenerateTwoArtifactsRoleDefaultPolicy770BE7EA
      Roles:
        - Ref: CodeCommitPipelineGenerateTwoArtifactsRole91D2CDCA
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GenerateTwoArtifacts/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineGenerateTwoArtifactsA9DAD33B:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineGenerateTwoArtifactsScriptDirectoryS3BucketE058B7EF
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineGenerateTwoArtifactsScriptDirectoryS3VersionKeyD775EF3D
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineGenerateTwoArtifactsScriptDirectoryS3VersionKeyD775EF3D
        Image: aws/codebuild/ubuntu-base:14.04
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineGenerateTwoArtifactsRole91D2CDCA
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                  "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                  "mkdir -p /tmp/scriptdir",
                  "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir"
                ]
              },
              "build": {
                "commands": [
                  "export SCRIPT_DIR=/tmp/scriptdir",
                  "echo \"Running void.sh\"",
                  "/bin/bash /tmp/scriptdir/void.sh",
                  "mkdir -p output1 output2",
                  "echo '{\"name\": \"output1\", \"version\": \"1.2.3\", \"commit\": \"abcdef\"}' > output1/build.json",
                  "echo '{\"name\": \"output2\", \"version\": \"1.2.3\", \"commit\": \"abcdef\"}' > output2/build.json"
                ]
              }
            },
            "artifacts": {
              "secondary-artifacts": {
                "artifact2": {
                  "base-directory": "output2",
                  "files": [
                    "**/*"
                  ]
                },
                "Artifact_delivlibtestCodeCommitPipelineGenerateTwoArtifacts54497DAA": {
                  "base-directory": "output1",
                  "files": [
                    "**/*"
                  ]
                }
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GenerateTwoArtifacts/Resource/Resource
  CodeCommitPipelineGenerateTwoArtifactsAlarm4299580B:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Threshold: 1
      Dimensions:
        - Name: ProjectName
          Value:
            Ref: CodeCommitPipelineGenerateTwoArtifactsA9DAD33B
      MetricName: FailedBuilds
      Namespace: AWS/CodeBuild
      Period: 300
      Statistic: Sum
      TreatMissingData: ignore
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GenerateTwoArtifacts/Alarm/Resource
  CodeCommitPipelineCanaryHelloCanaryShellableRole65D634EB:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/CanaryHelloCanary/Shellable/Resource/Role/Resource
  CodeCommitPipelineCanaryHelloCanaryShellableRoleDefaultPolicyD466B3CA:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineCanaryHelloCanaryShellableC8458471
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineCanaryHelloCanaryShellableC8458471
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineCanaryHelloCanaryShellableScriptDirectoryS3BucketFE4212CD
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineCanaryHelloCanaryShellableScriptDirectoryS3BucketFE4212CD
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineCanaryHelloCanaryShellableScriptDirectoryS3VersionKey8BCEB745
                    - "*"
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineCanaryHelloCanaryShellableRoleDefaultPolicyD466B3CA
      Roles:
        - Ref: CodeCommitPipelineCanaryHelloCanaryShellableRole65D634EB
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/CanaryHelloCanary/Shellable/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineCanaryHelloCanaryShellableC8458471:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: NO_ARTIFACTS
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineCanaryHelloCanaryShellableScriptDirectoryS3BucketFE4212CD
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineCanaryHelloCanaryShellableScriptDirectoryS3VersionKey8BCEB745
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineCanaryHelloCanaryShellableScriptDirectoryS3VersionKey8BCEB745
          - Name: IS_CANARY
            Type: PLAINTEXT
            Value: "true"
        Image: aws/codebuild/ubuntu-base:14.04
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineCanaryHelloCanaryShellableRole65D634EB
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                  "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                  "mkdir -p /tmp/scriptdir",
                  "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir"
                ]
              },
              "build": {
                "commands": [
                  "export SCRIPT_DIR=/tmp/scriptdir",
                  "echo \"Running test.sh\"",
                  "/bin/bash /tmp/scriptdir/test.sh"
                ]
              }
            }
          }
        Type: NO_SOURCE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/CanaryHelloCanary/Shellable/Resource/Resource
  CodeCommitPipelineCanaryHelloCanaryShellableEventsRole0F756230:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/CanaryHelloCanary/Shellable/Resource/EventsRole/Resource
  CodeCommitPipelineCanaryHelloCanaryShellableEventsRoleDefaultPolicy6CE0D6E4:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: codebuild:StartBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineCanaryHelloCanaryShellableC8458471
                - Arn
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineCanaryHelloCanaryShellableEventsRoleDefaultPolicy6CE0D6E4
      Roles:
        - Ref: CodeCommitPipelineCanaryHelloCanaryShellableEventsRole0F756230
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/CanaryHelloCanary/Shellable/Resource/EventsRole/DefaultPolicy/Resource
  CodeCommitPipelineCanaryHelloCanaryShellableAlarm049B43C4:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Threshold: 1
      Dimensions:
        - Name: ProjectName
          Value:
            Ref: CodeCommitPipelineCanaryHelloCanaryShellableC8458471
      MetricName: FailedBuilds
      Namespace: AWS/CodeBuild
      Period: 300
      Statistic: Sum
      TreatMissingData: ignore
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/CanaryHelloCanary/Shellable/Alarm/Resource
  CodeCommitPipelineCanaryHelloCanarySchedule6177762B:
    Type: AWS::Events::Rule
    Properties:
      ScheduleExpression: rate(1 minute)
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - CodeCommitPipelineCanaryHelloCanaryShellableC8458471
              - Arn
          Id: Resource
          RoleArn:
            Fn::GetAtt:
              - CodeCommitPipelineCanaryHelloCanaryShellableEventsRole0F756230
              - Arn
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/CanaryHelloCanary/Schedule/Resource
  CodeCommitPipelineNpmRole219D5F49:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/Npm/Default/Resource/Role/Resource
  CodeCommitPipelineNpmRoleDefaultPolicy1AFB68F0:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineNpm0D31AEFC
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineNpm0D31AEFC
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineNpmScriptDirectoryS3BucketFC1B4A74
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineNpmScriptDirectoryS3BucketFC1B4A74
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineNpmScriptDirectoryS3VersionKey007F90CF
                    - "*"
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/npm-OynG62
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineNpmRoleDefaultPolicy1AFB68F0
      Roles:
        - Ref: CodeCommitPipelineNpmRole219D5F49
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/Npm/Default/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineNpm0D31AEFC:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineNpmScriptDirectoryS3BucketFC1B4A74
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineNpmScriptDirectoryS3VersionKey007F90CF
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineNpmScriptDirectoryS3VersionKey007F90CF
          - Name: FOR_REAL
            Type: PLAINTEXT
            Value: "true"
          - Name: NPM_TOKEN_SECRET
            Type: PLAINTEXT
            Value: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/npm-OynG62
          - Name: DISTTAG
            Type: PLAINTEXT
            Value: ""
        Image: aws/codebuild/nodejs:10.1.0
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineNpmRole219D5F49
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                  "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                  "mkdir -p /tmp/scriptdir",
                  "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir"
                ]
              },
              "build": {
                "commands": [
                  "export SCRIPT_DIR=/tmp/scriptdir",
                  "echo \"Running publish.sh\"",
                  "/bin/bash /tmp/scriptdir/publish.sh"
                ]
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/Npm/Default/Resource/Resource
  CodeCommitPipelineNpmAlarm7A04F7A3:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Threshold: 1
      Dimensions:
        - Name: ProjectName
          Value:
            Ref: CodeCommitPipelineNpm0D31AEFC
      MetricName: FailedBuilds
      Namespace: AWS/CodeBuild
      Period: 300
      Statistic: Sum
      TreatMissingData: ignore
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/Npm/Default/Alarm/Resource
  CodeCommitPipelineNuGetRole488DA302:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/NuGet/Default/Resource/Role/Resource
  CodeCommitPipelineNuGetRoleDefaultPolicy9AF66D81:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineNuGet67CE1BA7
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineNuGet67CE1BA7
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineNuGetScriptDirectoryS3Bucket3EE4493E
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineNuGetScriptDirectoryS3Bucket3EE4493E
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineNuGetScriptDirectoryS3VersionKeyA319F624
                    - "*"
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/nuget-fHzSUD
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - X509CodeSigningKeyRSAPrivateKeyE5980A70
                - SecretArn
          - Action: ssm:GetParameter
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - :ssm:us-east-1:712950704752:parameter
                  - Ref: X509CodeSigningKey8DE65BF8
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineNuGetRoleDefaultPolicy9AF66D81
      Roles:
        - Ref: CodeCommitPipelineNuGetRole488DA302
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/NuGet/Default/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineNuGet67CE1BA7:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineNuGetScriptDirectoryS3Bucket3EE4493E
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineNuGetScriptDirectoryS3VersionKeyA319F624
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineNuGetScriptDirectoryS3VersionKeyA319F624
          - Name: FOR_REAL
            Type: PLAINTEXT
            Value: "true"
          - Name: NUGET_SECRET_REGION
            Type: PLAINTEXT
            Value: us-east-1
          - Name: NUGET_SECRET_ID
            Type: PLAINTEXT
            Value: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/nuget-fHzSUD
          - Name: CODE_SIGNING_SECRET_ID
            Type: PLAINTEXT
            Value:
              Fn::GetAtt:
                - X509CodeSigningKeyRSAPrivateKeyE5980A70
                - SecretArn
          - Name: CODE_SIGNING_PARAMETER_NAME
            Type: PLAINTEXT
            Value:
              Ref: X509CodeSigningKey8DE65BF8
        Image: aws/codebuild/dot-net:core-2.1
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineNuGetRole488DA302
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                  "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                  "mkdir -p /tmp/scriptdir",
                  "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir"
                ]
              },
              "build": {
                "commands": [
                  "export SCRIPT_DIR=/tmp/scriptdir",
                  "echo \"Running publish.sh\"",
                  "/bin/bash /tmp/scriptdir/publish.sh"
                ]
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/NuGet/Default/Resource/Resource
  CodeCommitPipelineNuGetAlarm4F3CAC42:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Threshold: 1
      Dimensions:
        - Name: ProjectName
          Value:
            Ref: CodeCommitPipelineNuGet67CE1BA7
      MetricName: FailedBuilds
      Namespace: AWS/CodeBuild
      Period: 300
      Statistic: Sum
      TreatMissingData: ignore
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/NuGet/Default/Alarm/Resource
  CodeCommitPipelineMavenRoleC3A7769B:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/Maven/Default/Resource/Role/Resource
  CodeCommitPipelineMavenRoleDefaultPolicyBCD15357:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineMavenB7154296
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineMavenB7154296
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineMavenScriptDirectoryS3Bucket8BD14FB0
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineMavenScriptDirectoryS3Bucket8BD14FB0
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineMavenScriptDirectoryS3VersionKey8E6343D1
                    - "*"
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/maven-7ROCWi
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeSign52FB6674
                - SecretArn
          - Action: kms:Decrypt
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeSignCMKC986BB89
                - Arn
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineMavenRoleDefaultPolicyBCD15357
      Roles:
        - Ref: CodeCommitPipelineMavenRoleC3A7769B
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/Maven/Default/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineMavenB7154296:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineMavenScriptDirectoryS3Bucket8BD14FB0
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineMavenScriptDirectoryS3VersionKey8E6343D1
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineMavenScriptDirectoryS3VersionKey8E6343D1
          - Name: STAGING_PROFILE_ID
            Type: PLAINTEXT
            Value: 68a05363083174
          - Name: SIGNING_KEY_ARN
            Type: PLAINTEXT
            Value:
              Fn::GetAtt:
                - CodeSign52FB6674
                - SecretArn
          - Name: FOR_REAL
            Type: PLAINTEXT
            Value: "true"
          - Name: MAVEN_LOGIN_SECRET
            Type: PLAINTEXT
            Value: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/maven-7ROCWi
        Image: aws/codebuild/nodejs:10.1.0
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineMavenRoleC3A7769B
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                  "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                  "mkdir -p /tmp/scriptdir",
                  "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir"
                ]
              },
              "build": {
                "commands": [
                  "export SCRIPT_DIR=/tmp/scriptdir",
                  "echo \"Running publish.sh\"",
                  "/bin/bash /tmp/scriptdir/publish.sh"
                ]
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/Maven/Default/Resource/Resource
  CodeCommitPipelineMavenAlarmC4A88DC3:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Threshold: 1
      Dimensions:
        - Name: ProjectName
          Value:
            Ref: CodeCommitPipelineMavenB7154296
      MetricName: FailedBuilds
      Namespace: AWS/CodeBuild
      Period: 300
      Statistic: Sum
      TreatMissingData: ignore
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/Maven/Default/Alarm/Resource
  CodeCommitPipelineGitHubRole77F2217D:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GitHub/Default/Resource/Role/Resource
  CodeCommitPipelineGitHubRoleDefaultPolicy3FEA7E07:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineGitHub0797840C
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineGitHub0797840C
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineGitHubScriptDirectoryS3Bucket0F36AC0A
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineGitHubScriptDirectoryS3Bucket0F36AC0A
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineGitHubScriptDirectoryS3VersionKey1C039B7C
                    - "*"
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeSign52FB6674
                - SecretArn
          - Action: kms:Decrypt
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeSignCMKC986BB89
                - Arn
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineGitHubRoleDefaultPolicy3FEA7E07
      Roles:
        - Ref: CodeCommitPipelineGitHubRole77F2217D
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GitHub/Default/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineGitHub0797840C:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineGitHubScriptDirectoryS3Bucket0F36AC0A
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineGitHubScriptDirectoryS3VersionKey1C039B7C
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineGitHubScriptDirectoryS3VersionKey1C039B7C
          - Name: BUILD_MANIFEST
            Type: PLAINTEXT
            Value: ./build.json
          - Name: CHANGELOG
            Type: PLAINTEXT
            Value: ./CHANGELOG.md
          - Name: SIGNING_KEY_ARN
            Type: PLAINTEXT
            Value:
              Fn::GetAtt:
                - CodeSign52FB6674
                - SecretArn
          - Name: GITHUB_TOKEN
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineGitHubGitHubTokenParameterA51FA80C
          - Name: GITHUB_OWNER
            Type: PLAINTEXT
            Value: awslabs
          - Name: GITHUB_REPO
            Type: PLAINTEXT
            Value: aws-delivlib-sample
          - Name: FOR_REAL
            Type: PLAINTEXT
            Value: "true"
          - Name: SECONDARY_SOURCE_NAMES
            Type: PLAINTEXT
            Value: Artifact_delivlibtestCodeCommitPipelineGenerateTwoArtifacts54497DAA
              artifact2
          - Name: SIGN_ADDITIONAL_ARTIFACTS
            Type: PLAINTEXT
            Value: "true"
        Image: aws/codebuild/nodejs:10.1.0
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineGitHubRole77F2217D
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                  "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                  "mkdir -p /tmp/scriptdir",
                  "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir"
                ]
              },
              "build": {
                "commands": [
                  "export SCRIPT_DIR=/tmp/scriptdir",
                  "echo \"Running publish.sh\"",
                  "/bin/bash /tmp/scriptdir/publish.sh"
                ]
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GitHub/Default/Resource/Resource
  CodeCommitPipelineGitHubAlarmBD31FE64:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Threshold: 1
      Dimensions:
        - Name: ProjectName
          Value:
            Ref: CodeCommitPipelineGitHub0797840C
      MetricName: FailedBuilds
      Namespace: AWS/CodeBuild
      Period: 300
      Statistic: Sum
      TreatMissingData: ignore
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GitHub/Default/Alarm/Resource
  CodeCommitPipelineGitHubPagesRole10784D1D:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GitHubPages/Default/Resource/Role/Resource
  CodeCommitPipelineGitHubPagesRoleDefaultPolicy23292E7F:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineGitHubPages53B77CF6
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineGitHubPages53B77CF6
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineGitHubPagesScriptDirectoryS3BucketFC75D454
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelineGitHubPagesScriptDirectoryS3BucketFC75D454
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelineGitHubPagesScriptDirectoryS3VersionKey5CE2FF2C
                    - "*"
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/github-ssh-lwzfjW
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineGitHubPagesRoleDefaultPolicy23292E7F
      Roles:
        - Ref: CodeCommitPipelineGitHubPagesRole10784D1D
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GitHubPages/Default/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelineGitHubPages53B77CF6:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelineGitHubPagesScriptDirectoryS3BucketFC75D454
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineGitHubPagesScriptDirectoryS3VersionKey5CE2FF2C
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelineGitHubPagesScriptDirectoryS3VersionKey5CE2FF2C
          - Name: GITHUB_REPO
            Type: PLAINTEXT
            Value: git@github.com:awslabs/aws-delivlib-sample.git
          - Name: GITHUB_PAGES_BRANCH
            Type: PLAINTEXT
            Value: gh-pages
          - Name: SSH_KEY_SECRET
            Type: PLAINTEXT
            Value: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/github-ssh-lwzfjW
          - Name: FOR_REAL
            Type: PLAINTEXT
            Value: "true"
          - Name: COMMIT_USERNAME
            Type: PLAINTEXT
            Value: foobar
          - Name: COMMIT_EMAIL
            Type: PLAINTEXT
            Value: foo@bar.com
          - Name: BUILD_MANIFEST
            Type: PLAINTEXT
            Value: ./build.json
        Image: aws/codebuild/nodejs:10.1.0
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineGitHubPagesRole10784D1D
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                  "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                  "mkdir -p /tmp/scriptdir",
                  "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir"
                ]
              },
              "build": {
                "commands": [
                  "export SCRIPT_DIR=/tmp/scriptdir",
                  "echo \"Running publish.sh\"",
                  "/bin/bash /tmp/scriptdir/publish.sh"
                ]
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GitHubPages/Default/Resource/Resource
  CodeCommitPipelineGitHubPagesAlarmC5B4BC57:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Threshold: 1
      Dimensions:
        - Name: ProjectName
          Value:
            Ref: CodeCommitPipelineGitHubPages53B77CF6
      MetricName: FailedBuilds
      Namespace: AWS/CodeBuild
      Period: 300
      Statistic: Sum
      TreatMissingData: ignore
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/GitHubPages/Default/Alarm/Resource
  CodeCommitPipelinePyPIRole30E20A9B:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PyPI/Default/Resource/Role/Resource
  CodeCommitPipelinePyPIRoleDefaultPolicy5062B3BA:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelinePyPI2C59CE7B
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelinePyPI2C59CE7B
                    - :*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelinePyPIScriptDirectoryS3BucketA2764F2D
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: CodeCommitPipelinePyPIScriptDirectoryS3BucketA2764F2D
                    - /
                    - Fn::Select:
                        - 0
                        - Fn::Split:
                            - "||"
                            - Ref: CodeCommitPipelinePyPIScriptDirectoryS3VersionKeyECBD841C
                    - "*"
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/pypi-tOhH6X
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject*
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineBuildPipelineArtifactsBucketED2813B3
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelinePyPIRoleDefaultPolicy5062B3BA
      Roles:
        - Ref: CodeCommitPipelinePyPIRole30E20A9B
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PyPI/Default/Resource/Role/DefaultPolicy/Resource
  CodeCommitPipelinePyPI2C59CE7B:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: SCRIPT_S3_BUCKET
            Type: PLAINTEXT
            Value:
              Ref: CodeCommitPipelinePyPIScriptDirectoryS3BucketA2764F2D
          - Name: SCRIPT_S3_KEY
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelinePyPIScriptDirectoryS3VersionKeyECBD841C
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "||"
                          - Ref: CodeCommitPipelinePyPIScriptDirectoryS3VersionKeyECBD841C
          - Name: FOR_REAL
            Type: PLAINTEXT
            Value: "true"
          - Name: PYPI_CREDENTIALS_SECRET_ID
            Type: PLAINTEXT
            Value: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/pypi-tOhH6X
        Image: aws/codebuild/python:3.6.5
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelinePyPIRole30E20A9B
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "echo \"Downloading scripts from s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY}\"",
                  "aws s3 cp s3://${SCRIPT_S3_BUCKET}/${SCRIPT_S3_KEY} /tmp",
                  "mkdir -p /tmp/scriptdir",
                  "unzip /tmp/$(basename $SCRIPT_S3_KEY) -d /tmp/scriptdir"
                ]
              },
              "build": {
                "commands": [
                  "export SCRIPT_DIR=/tmp/scriptdir",
                  "echo \"Running publish.sh\"",
                  "/bin/bash /tmp/scriptdir/publish.sh"
                ]
              }
            }
          }
        Type: CODEPIPELINE
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PyPI/Default/Resource/Resource
  CodeCommitPipelinePyPIAlarmEA15EF14:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Threshold: 1
      Dimensions:
        - Name: ProjectName
          Value:
            Ref: CodeCommitPipelinePyPI2C59CE7B
      MetricName: FailedBuilds
      Namespace: AWS/CodeBuild
      Period: 300
      Statistic: Sum
      TreatMissingData: ignore
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/PyPI/Default/Alarm/Resource
  CodeCommitPipelineAutoBumpRole669D4CAA:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/AutoBump/Bump/Role/Resource
  CodeCommitPipelineAutoBumpRoleDefaultPolicyD6024577:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineAutoBumpA6619552
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :logs:us-east-1:712950704752:log-group:/aws/codebuild/
                    - Ref: CodeCommitPipelineAutoBumpA6619552
                    - :*
          - Action:
              - secretsmanager:ListSecrets
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource: arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/github-ssh-lwzfjW
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineAutoBumpRoleDefaultPolicyD6024577
      Roles:
        - Ref: CodeCommitPipelineAutoBumpRole669D4CAA
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/AutoBump/Bump/Role/DefaultPolicy/Resource
  CodeCommitPipelineAutoBumpA6619552:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: NO_ARTIFACTS
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: jsii/superchain:latest
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CodeCommitPipelineAutoBumpRole669D4CAA
          - Arn
      Source:
        Auth:
          Resource:
            Ref: CodeCommitPipelineAutoBumpGitHubTokenParameter20350017
          Type: OAUTH
        BuildSpec: >-
          {
            "version": "0.2",
            "phases": {
              "pre_build": {
                "commands": [
                  "git config --global user.email \"foo@bar.com\"",
                  "git config --global user.name \"foobar\""
                ]
              },
              "build": {
                "commands": [
                  "git describe --exact-match HEAD && { echo \"No new commits.\"; export SKIP=true; } || { echo \"Changes to release.\"; export SKIP=false; }",
                  "$SKIP || { npm i && npm run bump; }",
                  "$SKIP || aws secretsmanager get-secret-value --secret-id \"arn:aws:secretsmanager:us-east-1:712950704752:secret:delivlib/github-ssh-lwzfjW\" --output=text --query=SecretString > ~/.ssh/id_rsa",
                  "$SKIP || chmod 0600 ~/.ssh/id_rsa",
                  "$SKIP || { BRANCH=bump/$(git describe) ; }",
                  "$SKIP || { git branch -D $BRANCH || true ; }",
                  "$SKIP || { git checkout -b $BRANCH ; }",
                  "$SKIP || { git checkout master ; }",
                  "$SKIP || { git merge $BRANCH ; }",
                  "$SKIP || { git remote add origin_ssh git@github.com:awslabs/aws-delivlib-sample.git ; }",
                  "$SKIP || { git push --follow-tags origin_ssh master ; }"
                ]
              }
            }
          }
        Location: https://github.com/awslabs/aws-delivlib-sample.git
        ReportBuildStatus: true
        Type: GITHUB
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/AutoBump/Bump/Resource
  CodeCommitPipelineAutoBumpEventsRole63A4AC28:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/AutoBump/Bump/EventsRole/Resource
  CodeCommitPipelineAutoBumpEventsRoleDefaultPolicy20B2B829:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: codebuild:StartBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CodeCommitPipelineAutoBumpA6619552
                - Arn
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineAutoBumpEventsRoleDefaultPolicy20B2B829
      Roles:
        - Ref: CodeCommitPipelineAutoBumpEventsRole63A4AC28
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/AutoBump/Bump/EventsRole/DefaultPolicy/Resource
  CodeCommitPipelineAutoBumpSchedulerC4D05D9B:
    Type: AWS::Events::Rule
    Properties:
      Description: Schedules an automatic bump for this repository
      ScheduleExpression: cron(0 12 * * ? *)
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - CodeCommitPipelineAutoBumpA6619552
              - Arn
          Id: Bump
          RoleArn:
            Fn::GetAtt:
              - CodeCommitPipelineAutoBumpEventsRole63A4AC28
              - Arn
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/AutoBump/Scheduler/Resource
  CodeCommitPipelineAutoBumpBumpFailedAlarm47B5C467:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Threshold: 1
      Dimensions:
        - Name: ProjectName
          Value:
            Ref: CodeCommitPipelineAutoBumpA6619552
      MetricName: FailedBuilds
      Namespace: AWS/CodeBuild
      Period: 300
      Statistic: Sum
      TreatMissingData: ignore
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/AutoBump/BumpFailedAlarm/Resource
  CodeCommitPipelineChangeControllerCalendar94B1DEA8:
    Type: AWS::S3::Bucket
    Properties:
      VersioningConfiguration:
        Status: Enabled
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/ChangeController/Calendar/Resource
  CodeCommitPipelineChangeControllerCalendarNotifications1AFBE6E9:
    Type: Custom::S3BucketNotifications
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - BucketNotificationsHandler050a0587b7544547bf325f094a3db8347ECC3691
          - Arn
      BucketName:
        Ref: CodeCommitPipelineChangeControllerCalendar94B1DEA8
      NotificationConfiguration:
        LambdaFunctionConfigurations:
          - Events:
              - s3:ObjectCreated:*
            Filter:
              Key:
                FilterRules:
                  - Name: prefix
                    Value: change-control.ics
            LambdaFunctionArn:
              Fn::GetAtt:
                - CodeCommitPipelineChangeControllerFunction776EAE6A
                - Arn
    DependsOn:
      - CodeCommitPipelineChangeControllerFunctionAllowBucketNotificationsFromdelivlibtestCodeCommitPipelineChangeControllerCalendarEBE698816996B3BB
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/ChangeController/Calendar/Notifications/Resource
  CodeCommitPipelineChangeControllerFunctionServiceRoleF02841DB:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/ChangeController/Function/ServiceRole/Resource
  CodeCommitPipelineChangeControllerFunctionServiceRoleDefaultPolicy315F7AF5:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - codepipeline:EnableStageTransition
              - codepipeline:DisableStageTransition
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":codepipeline:us-east-1:712950704752:"
                  - Ref: CodeCommitPipelineBuildPipeline656B8CCB
                  - /Publish
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - CodeCommitPipelineChangeControllerCalendar94B1DEA8
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - CodeCommitPipelineChangeControllerCalendar94B1DEA8
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: CodeCommitPipelineChangeControllerFunctionServiceRoleDefaultPolicy315F7AF5
      Roles:
        - Ref: CodeCommitPipelineChangeControllerFunctionServiceRoleF02841DB
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/ChangeController/Function/ServiceRole/DefaultPolicy/Resource
  CodeCommitPipelineChangeControllerFunction776EAE6A:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: CodeCommitPipelineChangeControllerFunctionCodeS3BucketD3AE9241
        S3Key:
          Fn::Join:
            - ""
            - - Fn::Select:
                  - 0
                  - Fn::Split:
                      - "||"
                      - Ref: CodeCommitPipelineChangeControllerFunctionCodeS3VersionKey1A85D84D
              - Fn::Select:
                  - 1
                  - Fn::Split:
                      - "||"
                      - Ref: CodeCommitPipelineChangeControllerFunctionCodeS3VersionKey1A85D84D
      Handler: index.handler
      Role:
        Fn::GetAtt:
          - CodeCommitPipelineChangeControllerFunctionServiceRoleF02841DB
          - Arn
      Runtime: nodejs8.10
      Description: Enforces a Change Control Policy into CodePipeline's Publish stage
      Environment:
        Variables:
          CHANGE_CONTROL_BUCKET_NAME:
            Ref: CodeCommitPipelineChangeControllerCalendar94B1DEA8
          CHANGE_CONTROL_OBJECT_KEY: change-control.ics
          PIPELINE_NAME:
            Ref: CodeCommitPipelineBuildPipeline656B8CCB
          STAGE_NAME: Publish
      Timeout: 300
    DependsOn:
      - CodeCommitPipelineChangeControllerFunctionServiceRoleDefaultPolicy315F7AF5
      - CodeCommitPipelineChangeControllerFunctionServiceRoleF02841DB
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/ChangeController/Function/Resource
  CodeCommitPipelineChangeControllerFunctionAllowBucketNotificationsFromdelivlibtestCodeCommitPipelineChangeControllerCalendarEBE698816996B3BB:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: CodeCommitPipelineChangeControllerFunction776EAE6A
      Principal: s3.amazonaws.com
      SourceAccount: "712950704752"
      SourceArn:
        Fn::GetAtt:
          - CodeCommitPipelineChangeControllerCalendar94B1DEA8
          - Arn
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/ChangeController/Function/AllowBucketNotificationsFromdelivlibtestCodeCommitPipelineChangeControllerCalendarEBE69881
  CodeCommitPipelineChangeControllerFunctionAllowEventRuledelivlibtestCodeCommitPipelineChangeControllerRule9C4D9DE885142D66:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: CodeCommitPipelineChangeControllerFunction776EAE6A
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
          - CodeCommitPipelineChangeControllerRuleAEEA7A52
          - Arn
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/ChangeController/Function/AllowEventRuledelivlibtestCodeCommitPipelineChangeControllerRule9C4D9DE8
  CodeCommitPipelineChangeControllerFailed03331BFB:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      Threshold: 1
      DatapointsToAlarm: 1
      Dimensions:
        - Name: FunctionName
          Value:
            Ref: CodeCommitPipelineChangeControllerFunction776EAE6A
      MetricName: Errors
      Namespace: AWS/Lambda
      Period: 300
      Statistic: Sum
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/ChangeController/Failed/Resource
  CodeCommitPipelineChangeControllerRuleAEEA7A52:
    Type: AWS::Events::Rule
    Properties:
      Description:
        Fn::Join:
          - ""
          - - "Run the change controller for promotions into "
            - Ref: CodeCommitPipelineBuildPipeline656B8CCB
            - "'s Publish on a rate(15 minutes) schedule"
      ScheduleExpression: rate(15 minutes)
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - CodeCommitPipelineChangeControllerFunction776EAE6A
              - Arn
          Id: Function
    Metadata:
      aws:cdk:path: delivlib-test/CodeCommitPipeline/ChangeController/Rule/Resource
  AssumeMe924099BB:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Condition:
              StringEquals:
                sts:ExternalId: require-me-please
            Effect: Allow
            Principal:
              AWS:
                Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :iam::712950704752:root
        Version: "2012-10-17"
    Metadata:
      aws:cdk:path: delivlib-test/AssumeMe/Resource
  X509CodeSigningKeyRSAPrivateKeyE5980A70:
    Type: Custom::RsaPrivateKeySecret
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - RSAPrivateKey72FD327D38134632934028EC437AA486D8EE708F
          - Arn
      ResourceVersion: J1G9PwnefOm+V5RoZ2gea8L11MLb3EGOmvE92Y/E6fM=
      Description: The PEM-encoded private key of the x509 Code-Signing Certificate
      KeySize: 2048
      SecretName: delivlib-test/X509CodeSigningKey/RSAPrivateKey
    DependsOn:
      - RSAPrivateKey72FD327D38134632934028EC437AA486ServiceRoleDefaultPolicy487DB1EA
      - RSAPrivateKey72FD327D38134632934028EC437AA486ServiceRole76094455
    DeletionPolicy: Retain
    Metadata:
      aws:cdk:path: delivlib-test/X509CodeSigningKey/RSAPrivateKey/Resource
  X509CodeSigningKeyRSAPrivateKeyCertificateSigningRequest7F706C9D:
    Type: Custom::CertificateSigningRequest
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - CreateCSR541F67826DCF49A78C5A67715ADD9E4C8F4169F6
          - Arn
      ResourceVersion: NoT8wts2zoCTJfaEBKdHwqykhwjq0NVqcO0CcWTMGQA=
      PrivateKeySecretId:
        Fn::GetAtt:
          - X509CodeSigningKeyRSAPrivateKeyE5980A70
          - SecretArn
      DnCommonName: delivlib-test
      DnCountry: IL
      DnStateOrProvince: Ztate
      DnLocality: Zity
      DnOrganizationName: Amazon Test
      DnOrganizationalUnitName: AWS
      DnEmailAddress: aws-cdk-dev+delivlib-test@amazon.com
      ExtendedKeyUsage: critical,codeSigning
      KeyUsage: critical,digitalSignature
    DependsOn:
      - CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleDefaultPolicyC0800208
      - CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleD2990C92
    Metadata:
      aws:cdk:path: delivlib-test/X509CodeSigningKey/RSAPrivateKey/CertificateSigningRequest/Resource
  X509CodeSigningKey8DE65BF8:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Value:
        Fn::GetAtt:
          - X509CodeSigningKeyRSAPrivateKeyCertificateSigningRequest7F706C9D
          - SelfSignedCertificate
      Description:
        Fn::Join:
          - ""
          - - "A PEM-encoded Code-Signing Certificate (private key in "
            - Fn::GetAtt:
                - X509CodeSigningKeyRSAPrivateKeyE5980A70
                - SecretArn
            - )
      Name: /delivlib-test/X509CodeSigningKey/Certificate
    Metadata:
      aws:cdk:path: delivlib-test/X509CodeSigningKey/Resource/Resource
  RSAPrivateKey72FD327D38134632934028EC437AA486ServiceRole76094455:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: delivlib-test/RSAPrivate-Key72FD327D38134632934028EC437AA486/ServiceRole/Resource
  RSAPrivateKey72FD327D38134632934028EC437AA486ServiceRoleDefaultPolicy487DB1EA:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - secretsmanager:CreateSecret
              - secretsmanager:DeleteSecret
              - secretsmanager:UpdateSecret
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - :secretsmanager:us-east-1:712950704752:secret:delivlib-test/X509CodeSigningKey/RSAPrivateKey-??????
        Version: "2012-10-17"
      PolicyName: RSAPrivateKey72FD327D38134632934028EC437AA486ServiceRoleDefaultPolicy487DB1EA
      Roles:
        - Ref: RSAPrivateKey72FD327D38134632934028EC437AA486ServiceRole76094455
    Metadata:
      aws:cdk:path: delivlib-test/RSAPrivate-Key72FD327D38134632934028EC437AA486/ServiceRole/DefaultPolicy/Resource
  RSAPrivateKey72FD327D38134632934028EC437AA486D8EE708F:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: RSAPrivateKey72FD327D38134632934028EC437AA486CodeS3BucketE105F27D
        S3Key:
          Fn::Join:
            - ""
            - - Fn::Select:
                  - 0
                  - Fn::Split:
                      - "||"
                      - Ref: RSAPrivateKey72FD327D38134632934028EC437AA486CodeS3VersionKey24DB0645
              - Fn::Select:
                  - 1
                  - Fn::Split:
                      - "||"
                      - Ref: RSAPrivateKey72FD327D38134632934028EC437AA486CodeS3VersionKey24DB0645
      Handler: index.handler
      Role:
        Fn::GetAtt:
          - RSAPrivateKey72FD327D38134632934028EC437AA486ServiceRole76094455
          - Arn
      Runtime: nodejs8.10
      Description: Generates an RSA Private Key and stores it in AWS Secrets Manager
      Timeout: 300
    DependsOn:
      - RSAPrivateKey72FD327D38134632934028EC437AA486ServiceRoleDefaultPolicy487DB1EA
      - RSAPrivateKey72FD327D38134632934028EC437AA486ServiceRole76094455
    Metadata:
      aws:cdk:path: delivlib-test/RSAPrivate-Key72FD327D38134632934028EC437AA486/Resource
  CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleD2990C92:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: delivlib-test/CreateCSR541F67826DCF49A78C5A67715ADD9E4C/ServiceRole/Resource
  CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleDefaultPolicyC0800208:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: secretsmanager:GetSecretValue
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - X509CodeSigningKeyRSAPrivateKeyE5980A70
                - SecretArn
        Version: "2012-10-17"
      PolicyName: CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleDefaultPolicyC0800208
      Roles:
        - Ref: CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleD2990C92
    Metadata:
      aws:cdk:path: delivlib-test/CreateCSR541F67826DCF49A78C5A67715ADD9E4C/ServiceRole/DefaultPolicy/Resource
  CreateCSR541F67826DCF49A78C5A67715ADD9E4C8F4169F6:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: CreateCSR541F67826DCF49A78C5A67715ADD9E4CCodeS3Bucket45923B19
        S3Key:
          Fn::Join:
            - ""
            - - Fn::Select:
                  - 0
                  - Fn::Split:
                      - "||"
                      - Ref: CreateCSR541F67826DCF49A78C5A67715ADD9E4CCodeS3VersionKey9D63F460
              - Fn::Select:
                  - 1
                  - Fn::Split:
                      - "||"
                      - Ref: CreateCSR541F67826DCF49A78C5A67715ADD9E4CCodeS3VersionKey9D63F460
      Handler: index.handler
      Role:
        Fn::GetAtt:
          - CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleD2990C92
          - Arn
      Runtime: nodejs8.10
      Description: Creates a Certificate Signing Request document for an x509 certificate
      Timeout: 300
    DependsOn:
      - CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleDefaultPolicyC0800208
      - CreateCSR541F67826DCF49A78C5A67715ADD9E4CServiceRoleD2990C92
    Metadata:
      aws:cdk:path: delivlib-test/CreateCSR541F67826DCF49A78C5A67715ADD9E4C/Resource
  CodeSignCMKC986BB89:
    Type: AWS::KMS::Key
    Properties:
      KeyPolicy:
        Statement:
          - Action:
              - kms:Create*
              - kms:Describe*
              - kms:Enable*
              - kms:List*
              - kms:Put*
              - kms:Update*
              - kms:Revoke*
              - kms:Disable*
              - kms:Get*
              - kms:Delete*
              - kms:ScheduleKeyDeletion
              - kms:CancelKeyDeletion
            Effect: Allow
            Principal:
              AWS:
                Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - :iam::712950704752:root
            Resource: "*"
          - Action:
              - kms:Decrypt
              - kms:GenerateDataKey
            Condition:
              StringEquals:
                kms:ViaService: secretsmanager.us-east-1.amazonaws.com
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                  - SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRole410148CF
                  - Arn
            Resource: "*"
          - Action: kms:Decrypt
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                  - CodeCommitPipelineMavenRoleC3A7769B
                  - Arn
            Resource: "*"
          - Action: kms:Decrypt
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                  - CodeCommitPipelineGitHubRole77F2217D
                  - Arn
            Resource: "*"
        Version: "2012-10-17"
    DeletionPolicy: Retain
    Metadata:
      aws:cdk:path: delivlib-test/CodeSign-CMK/Resource
  CodeSign52FB6674:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - SingletonLambdaf25803d3054b44fc985f4860d7d6ee746203BDE6
          - Arn
      ResourceVersion: VVrILYyu7ZONNxT/mZGdOSrn13JdHPQGZxV0KooSlw4=
      Identity: aws-cdk-dev
      Email: aws-cdk-dev+delivlib@amazon.com
      Expiry: 4y
      KeySizeBits: 4096
      SecretName: delivlib-test/CodeSign
      KeyArn:
        Fn::GetAtt:
          - CodeSignCMKC986BB89
          - Arn
      Version: 0
    Metadata:
      aws:cdk:path: delivlib-test/CodeSign/Resource
  CodeSignPrincipal30E4C212:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Value:
        Fn::GetAtt:
          - CodeSign52FB6674
          - PublicKey
      Description:
        Fn::Join:
          - ""
          - - "The public part of the OpenPGP key in "
            - Fn::GetAtt:
                - CodeSign52FB6674
                - SecretArn
      Name: /delivlib-test/CodeSign.pub
    Metadata:
      aws:cdk:path: delivlib-test/CodeSign/Principal/Resource
  SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRole410148CF:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: delivlib-test/SingletonLambdaf25803d3054b44fc985f4860d7d6ee74/ServiceRole/Resource
  SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRoleDefaultPolicyA8FDF5BD:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - secretsmanager:CreateSecret
              - secretsmanager:GetSecretValue
              - secretsmanager:UpdateSecret
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - :secretsmanager:us-east-1:712950704752:secret:delivlib-test/CodeSign-??????
          - Action: ssm:DeleteParameter
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRoleDefaultPolicyA8FDF5BD
      Roles:
        - Ref: SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRole410148CF
    Metadata:
      aws:cdk:path: delivlib-test/SingletonLambdaf25803d3054b44fc985f4860d7d6ee74/ServiceRole/DefaultPolicy/Resource
  SingletonLambdaf25803d3054b44fc985f4860d7d6ee746203BDE6:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: SingletonLambdaf25803d3054b44fc985f4860d7d6ee74CodeS3BucketAC499781
        S3Key:
          Fn::Join:
            - ""
            - - Fn::Select:
                  - 0
                  - Fn::Split:
                      - "||"
                      - Ref: SingletonLambdaf25803d3054b44fc985f4860d7d6ee74CodeS3VersionKey10D2DDF5
              - Fn::Select:
                  - 1
                  - Fn::Split:
                      - "||"
                      - Ref: SingletonLambdaf25803d3054b44fc985f4860d7d6ee74CodeS3VersionKey10D2DDF5
      Handler: index.handler
      Role:
        Fn::GetAtt:
          - SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRole410148CF
          - Arn
      Runtime: nodejs8.10
      Description: Generates an OpenPGP Key and stores the private key in Secrets Manager
        and the public key in an SSM Parameter
      Timeout: 300
    DependsOn:
      - SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRoleDefaultPolicyA8FDF5BD
      - SingletonLambdaf25803d3054b44fc985f4860d7d6ee74ServiceRole410148CF
    Metadata:
      aws:cdk:path: delivlib-test/SingletonLambdaf25803d3054b44fc985f4860d7d6ee74/Resource
  BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleB6FB88EC:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: delivlib-test/BucketNotificationsHandler050a0587b7544547bf325f094a3db834/Role/Resource
  BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleDefaultPolicy2CF63D36:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: s3:PutBucketNotification
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleDefaultPolicy2CF63D36
      Roles:
        - Ref: BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleB6FB88EC
    Metadata:
      aws:cdk:path: delivlib-test/BucketNotificationsHandler050a0587b7544547bf325f094a3db834/Role/DefaultPolicy/Resource
  BucketNotificationsHandler050a0587b7544547bf325f094a3db8347ECC3691:
    Type: AWS::Lambda::Function
    Properties:
      Description: AWS CloudFormation handler for "Custom::S3BucketNotifications" resources
        (@aws-cdk/aws-s3)
      Code:
        ZipFile: >-
          exports.handler = (event, context) => {
              const s3 = new (require('aws-sdk').S3)();
              const https = require("https");
              const url = require("url");
              log(JSON.stringify(event, undefined, 2));
              const props = event.ResourceProperties;
              if (event.RequestType === 'Delete') {
                  props.NotificationConfiguration = {}; // this is how you clean out notifications
              }
              const req = {
                  Bucket: props.BucketName,
                  NotificationConfiguration: props.NotificationConfiguration
              };
              return s3.putBucketNotificationConfiguration(req, (err, data) => {
                  log({ err, data });
                  if (err) {
                      return submitResponse("FAILED", err.message + `\nMore information in CloudWatch Log Stream: ${context.logStreamName}`);
                  }
                  else {
                      return submitResponse("SUCCESS");
                  }
              });
              function log(obj) {
                  console.error(event.RequestId, event.StackId, event.LogicalResourceId, obj);
              }
              // tslint:disable-next-line:max-line-length
              // adapted from https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-lambda-function-code.html#cfn-lambda-function-code-cfnresponsemodule
              // to allow sending an error messge as a reason.
              function submitResponse(responseStatus, reason) {
                  const responseBody = JSON.stringify({
                      Status: responseStatus,
                      Reason: reason || "See the details in CloudWatch Log Stream: " + context.logStreamName,
                      PhysicalResourceId: context.logStreamName,
                      StackId: event.StackId,
                      RequestId: event.RequestId,
                      LogicalResourceId: event.LogicalResourceId,
                      NoEcho: false,
                  });
                  log({ responseBody });
                  const parsedUrl = url.parse(event.ResponseURL);
                  const options = {
                      hostname: parsedUrl.hostname,
                      port: 443,
                      path: parsedUrl.path,
                      method: "PUT",
                      headers: {
                          "content-type": "",
                          "content-length": responseBody.length
                      }
                  };
                  const request = https.request(options, (r) => {
                      log({ statusCode: r.statusCode, statusMessage: r.statusMessage });
                      context.done();
                  });
                  request.on("error", (error) => {
                      log({ sendError: error });
                      context.done();
                  });
                  request.write(responseBody);
                  request.end();
              }
          };
      Handler: index.handler
      Role:
        Fn::GetAtt:
          - BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleB6FB88EC
          - Arn
      Runtime: nodejs8.10
      Timeout: 300
    Metadata:
      aws:cdk:path: delivlib-test/BucketNotificationsHandler050a0587b7544547bf325f094a3db834/Resource
Parameters:
  CodeCommitPipelineBuildPipelineGitHubTokenParameter9FBEDC6B:
    Type: AWS::SSM::Parameter::Value<String>
    Default: github-token
    NoEcho: true
  CodeCommitPipelineHelloLinuxScriptDirectoryS3Bucket56DFBFCD:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/HelloLinux/ScriptDirectory"
  CodeCommitPipelineHelloLinuxScriptDirectoryS3VersionKey0036B1AA:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/HelloLinux/ScriptDirectory"
  CodeCommitPipelineHelloWindowsScriptDirectoryS3Bucket368E02F9:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/HelloWindows/ScriptDirectory"
  CodeCommitPipelineHelloWindowsScriptDirectoryS3VersionKey00CFAE1A:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/HelloWindows/ScriptDirectory"
  CodeCommitPipelineAssumeRoleScriptDirectoryS3Bucket019558B4:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/AssumeRole/ScriptDirectory"
  CodeCommitPipelineAssumeRoleScriptDirectoryS3VersionKeyC04C2FE1:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/AssumeRole/ScriptDirectory"
  CodeCommitPipelineGenerateTwoArtifactsScriptDirectoryS3BucketE058B7EF:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/GenerateTwoArtifacts/ScriptDirectory"
  CodeCommitPipelineGenerateTwoArtifactsScriptDirectoryS3VersionKeyD775EF3D:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/GenerateTwoArtifacts/ScriptDirectory"
  CodeCommitPipelineCanaryHelloCanaryShellableScriptDirectoryS3BucketFE4212CD:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/CanaryHelloCanary/Shellable/ScriptDirectory"
  CodeCommitPipelineCanaryHelloCanaryShellableScriptDirectoryS3VersionKey8BCEB745:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/CanaryHelloCanary/Shellable/ScriptDirectory"
  CodeCommitPipelineNpmScriptDirectoryS3BucketFC1B4A74:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/Npm/Default/ScriptDirectory"
  CodeCommitPipelineNpmScriptDirectoryS3VersionKey007F90CF:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/Npm/Default/ScriptDirectory"
  CodeCommitPipelineNuGetScriptDirectoryS3Bucket3EE4493E:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/NuGet/Default/ScriptDirectory"
  CodeCommitPipelineNuGetScriptDirectoryS3VersionKeyA319F624:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/NuGet/Default/ScriptDirectory"
  CodeCommitPipelineMavenScriptDirectoryS3Bucket8BD14FB0:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/Maven/Default/ScriptDirectory"
  CodeCommitPipelineMavenScriptDirectoryS3VersionKey8E6343D1:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/Maven/Default/ScriptDirectory"
  CodeCommitPipelineGitHubGitHubTokenParameterA51FA80C:
    Type: AWS::SSM::Parameter::Value<String>
    Default: github-token
    NoEcho: true
  CodeCommitPipelineGitHubScriptDirectoryS3Bucket0F36AC0A:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/GitHub/Default/ScriptDirectory"
  CodeCommitPipelineGitHubScriptDirectoryS3VersionKey1C039B7C:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/GitHub/Default/ScriptDirectory"
  CodeCommitPipelineGitHubPagesScriptDirectoryS3BucketFC75D454:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/GitHubPages/Default/ScriptDirectory"
  CodeCommitPipelineGitHubPagesScriptDirectoryS3VersionKey5CE2FF2C:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/GitHubPages/Default/ScriptDirectory"
  CodeCommitPipelinePyPIScriptDirectoryS3BucketA2764F2D:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/PyPI/Default/ScriptDirectory"
  CodeCommitPipelinePyPIScriptDirectoryS3VersionKeyECBD841C:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/PyPI/Default/ScriptDirectory"
  CodeCommitPipelineAutoBumpGitHubTokenParameter20350017:
    Type: AWS::SSM::Parameter::Value<String>
    Default: github-token
    NoEcho: true
  CodeCommitPipelineChangeControllerFunctionCodeS3BucketD3AE9241:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CodeCommitPipeline/ChangeController/Function/Code"
  CodeCommitPipelineChangeControllerFunctionCodeS3VersionKey1A85D84D:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CodeCommitPipeline/ChangeController/Function/Code"
  RSAPrivateKey72FD327D38134632934028EC437AA486CodeS3BucketE105F27D:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/RSAPrivate-Key72FD327D38134632934028EC437AA486/Code"
  RSAPrivateKey72FD327D38134632934028EC437AA486CodeS3VersionKey24DB0645:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/RSAPrivate-Key72FD327D38134632934028EC437AA486/Code"
  CreateCSR541F67826DCF49A78C5A67715ADD9E4CCodeS3Bucket45923B19:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/CreateCSR541F67826DCF49A78C5A67715ADD9E4C/Code"
  CreateCSR541F67826DCF49A78C5A67715ADD9E4CCodeS3VersionKey9D63F460:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/CreateCSR541F67826DCF49A78C5A67715ADD9E4C/Code"
  SingletonLambdaf25803d3054b44fc985f4860d7d6ee74CodeS3BucketAC499781:
    Type: String
    Description: S3 bucket for asset
      "delivlib-test/SingletonLambdaf25803d3054b44fc985f4860d7d6ee74/Code"
  SingletonLambdaf25803d3054b44fc985f4860d7d6ee74CodeS3VersionKey10D2DDF5:
    Type: String
    Description: S3 key for asset version
      "delivlib-test/SingletonLambdaf25803d3054b44fc985f4860d7d6ee74/Code"
Outputs:
  CodeCommitPipelineChangeControllerChangeControlBucketKeyCA921D21:
    Value: change-control.ics
  CodeCommitPipelineChangeControllerChangeControlBucket707A9E21:
    Value:
      Ref: CodeCommitPipelineChangeControllerCalendar94B1DEA8
  X509CodeSigningKeyCSR5137C5A3:
    Description: A PEM-encoded Certificate Signing Request for a Code-Signing Certificate
    Value:
      Fn::GetAtt:
        - X509CodeSigningKeyRSAPrivateKeyCertificateSigningRequest7F706C9D
        - CSR

